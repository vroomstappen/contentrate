<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ContentRate Pro - Economy Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: #f8fafc; min-height: 100vh; }
        .glass-card { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease; }
        .glass-card:hover { border: 1px solid rgba(99, 102, 241, 0.3); }
        .grade-badge { padding: 4px 12px; border-radius: 8px; font-weight: 800; font-size: 0.7rem; text-transform: uppercase; border: 1px solid; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.5s ease-out forwards; }
        .loading-spinner { border: 3px solid rgba(99, 102, 241, 0.1); border-top: 3px solid #6366f1; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Economy Specific Styles */
        .coin-text { background: linear-gradient(to right, #fbbf24, #d97706); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .invest-input { background: transparent; border: none; text-align: center; font-weight: 900; color: white; width: 60px; }
        .invest-input:focus { outline: none; }
        
        /* Disabled Button State */
        .btn-disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }
    </style>
</head>
<body class="p-4 md:p-10">

    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
            <div>
                <h1 class="text-4xl font-extrabold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400">ContentRate <span class="text-white">Pro</span></h1>
                <p class="text-slate-500 font-medium">Content Farming Visualized</p>
            </div>

            <div class="glass-card px-6 py-2 rounded-2xl flex items-center gap-6 border border-amber-500/20 shadow-lg shadow-amber-900/10">
                <div class="flex flex-col items-end">
                    <span class="text-[10px] uppercase font-bold tracking-widest text-amber-500/80">Wallet Balance</span>
                    <div class="flex items-center gap-2">
                        <i data-lucide="coins" class="w-5 h-5 text-amber-400 fill-amber-400"></i>
                        <span id="walletBalance" class="text-2xl font-black text-amber-100">100</span>
                        <span class="text-xs font-bold text-amber-500">CP</span>
                    </div>
                </div>
                <div class="h-8 w-px bg-slate-700"></div>
                <button onclick="collectRewards()" id="collectBtn" class="bg-amber-500/10 hover:bg-amber-500/20 text-amber-400 px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wider transition border border-amber-500/50 flex items-center gap-2">
                    <i data-lucide="trophy" class="w-3 h-3"></i> 
                    <span id="collectBtnText">Collect Rewards</span>
                </button>
            </div>

            <div class="flex items-center gap-4">
                <div class="glass-card px-8 py-3 rounded-2xl flex flex-col items-center border border-slate-700/50">
                    <span class="text-[10px] uppercase font-bold tracking-widest text-slate-400 mb-1">Network Quality</span>
                    <div class="flex items-baseline gap-2">
                        <span id="networkQualityValue" class="text-3xl font-black text-slate-200">--</span>
                    </div>
                </div>

                <button onclick="toggleCompareMode()" id="compareBtn" class="px-6 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 transition flex items-center gap-2 text-sm font-bold shadow-lg shadow-indigo-500/20">
                    <i data-lucide="swords" class="w-4 h-4"></i> Compare
                </button>
            </div>
        </header>

        <div id="loading-state" class="flex flex-col items-center justify-center py-20">
            <div class="loading-spinner mb-4"></div>
            <p class="text-slate-500 font-bold animate-pulse">FETCHING LE DATA...</p>
        </div>

        <main id="view-container" class="hidden"></main>
    </div>

    <div id="compareModal" class="fixed inset-0 bg-slate-950/95 backdrop-blur-xl z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-800 w-full max-w-5xl rounded-3xl overflow-y-auto max-h-[90vh] shadow-2xl custom-scroll relative">
            <div class="sticky top-0 bg-slate-900/90 backdrop-blur-md p-6 border-b border-slate-800 flex justify-between items-center z-20">
                <h2 class="text-xl font-bold flex items-center gap-2 text-indigo-400">Head-to-Head Analysis</h2>
                <button onclick="toggleCompareMode()" class="p-2 hover:bg-slate-800 rounded-full transition"><i data-lucide="x"></i></button>
            </div>
            <div class="p-8 grid grid-cols-1 md:grid-cols-2 gap-10" id="compareContent"></div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 right-10 bg-slate-800 border border-slate-700 text-white px-6 py-4 rounded-xl shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 font-bold flex items-center gap-3">
        <span id="toastMsg">Notification</span>
    </div>

    <script>
        // --- CONFIG ---
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSMTqwP3ViGcOKh0lYRGL9rdAL-Q84U85iZSLTqwdT3OGXKhMvIsI-pNC_cbRjcod0teMJ7YbRXREhy/pub?gid=607342177&single=true&output=csv';
        const MAX_INVEST_PER_FARMER = 50;
        const MAX_FARMERS_INVESTED = 5;
        const SCORE_THRESHOLD = 6.5;
        const COOLDOWN_MS = 24 * 60 * 60 * 1000; // 24 Hours

        // --- STATE ---
        let processedFarmers = [];
        let compareSelection = [];
        let dailyBestScores = {};
        let cooldownTimerInterval;
        
        // Economy State (Persisted)
        let wallet = {
            balance: 100,
            investments: {}, // { 'farmer-id': amount }
            lastCollect: 0 // Timestamp
        };

        // --- HELPERS ---
        function getHexColor(score) {
            if (score <= 5.99) return '#ef4444';
            if (score <= 6.49) return '#f97316';
            if (score <= 6.99) return '#eab308';
            if (score <= 7.99) return '#22c55e';
            if (score <= 8.99) return '#3b82f6';
            return '#a855f7';
        }

        function getTailwindColor(score) {
            if (score <= 5.99) return 'text-red-500';
            if (score <= 6.49) return 'text-orange-500';
            if (score <= 6.99) return 'text-yellow-500';
            if (score <= 7.99) return 'text-green-500';
            if (score <= 8.99) return 'text-blue-500';
            return 'text-purple-500';
        }

        function showToast(msg, type = 'neutral') {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toastMsg');
            msgEl.innerHTML = msg;
            
            let color = 'border-slate-700';
            if(type === 'success') color = 'border-emerald-500 text-emerald-400';
            if(type === 'error') color = 'border-red-500 text-red-400';
            if(type === 'gold') color = 'border-amber-500 text-amber-400';
            
            toast.className = `fixed bottom-10 right-10 bg-slate-900 border ${color} px-6 py-4 rounded-xl shadow-2xl transform translate-y-0 opacity-100 transition-all duration-300 z-50 font-bold flex items-center gap-3`;
            
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // --- INITIALIZATION ---
        async function init() {
            // Load Wallet
            const savedWallet = localStorage.getItem('cp_wallet_v2'); // Changed version to v2 to reset clean
            if (savedWallet) {
                wallet = JSON.parse(savedWallet);
            }
            updateWalletUI();
            startCooldownTimer(); // Start the UI timer immediately

            try {
                const response = await fetch(SHEET_URL);
                const csvData = await response.text();
                
                Papa.parse(csvData, {
                    header: true,
                    dynamicTyping: true,
                    complete: (results) => {
                        processSheetData(results.data);
                    }
                });
            } catch (error) {
                console.error("Error loading data:", error);
                document.getElementById('loading-state').innerHTML = `<p class="text-red-400 font-bold">Failed to load Google Sheet. Check URL.</p>`;
            }
        }

        function processSheetData(rows) {
            const farmersMap = {};

            rows.forEach(row => {
                if (!row.Name) return;
                
                if (!farmersMap[row.Name]) {
                    farmersMap[row.Name] = {
                        id: row.Name.toLowerCase().replace(/\s/g, '-'),
                        name: row.Name,
                        scores: [],
                        attributes: {
                            creativity: row.Creativity || 70,
                            consistency: row.Consistency || 70,
                            attendance: row.Attendance || 70,
                            presence: row.Presence || 70,
                            quality: row.Quality || 70
                        },
                        accolades: row.Accolades ? [row.Accolades] : []
                    };
                }
                
                farmersMap[row.Name].scores.push({
                    date: row.Date,
                    score: parseFloat(row.Score)
                });

                if (!dailyBestScores[row.Date] || row.Score > dailyBestScores[row.Date]) {
                    dailyBestScores[row.Date] = row.Score;
                }
            });

            processedFarmers = Object.values(farmersMap).map(f => {
                f.scores.sort((a, b) => new Date(b.date) - new Date(a.date));
                const recentScores = f.scores.slice(0, 14);
                const avg = recentScores.reduce((a, b) => a + b.score, 0) / recentScores.length;
                const prevAvg = f.scores.slice(1, 15).length > 0 ? f.scores.slice(1, 15).reduce((a, b) => a + b.score, 0) / f.scores.slice(1, 15).length : avg;
                
                return {
                    ...f,
                    currentAvg: parseFloat(avg.toFixed(2)),
                    trend: avg > prevAvg ? 'up' : avg < prevAvg ? 'down' : 'equal',
                    grade: calculateGrade(avg)
                };
            }).sort((a, b) => b.currentAvg - a.currentAvg);

            const latestScoresSum = processedFarmers.reduce((sum, f) => {
                const latest = f.scores[0] ? f.scores[0].score : 0;
                return sum + latest;
            }, 0);
            
            const networkQuality = processedFarmers.length > 0 ? (latestScoresSum / processedFarmers.length) : 0;
            const qualityEl = document.getElementById('networkQualityValue');
            qualityEl.innerText = networkQuality.toFixed(2);
            qualityEl.className = `text-3xl font-black ${getTailwindColor(networkQuality)}`;

            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('view-container').classList.remove('hidden');
            renderLeaderboard();
        }

        function calculateGrade(score) {
            if (score >= 8.0) return { label: 'S-Tier', color: 'bg-purple-500/10 text-purple-400 border-purple-500/30' };
            if (score >= 7.5) return { label: 'A-Tier', color: 'bg-indigo-500/10 text-indigo-400 border-indigo-500/30' };
            if (score >= 6.5) return { label: 'B-Tier', color: 'bg-emerald-500/10 text-emerald-400 border-emerald-500/30' };
            return { label: 'C-Tier', color: 'bg-slate-500/10 text-slate-400 border-slate-500/30' };
        }

        // --- ECONOMY LOGIC ---
        
        function updateWalletUI() {
            const balEl = document.getElementById('walletBalance');
            if(balEl) balEl.innerText = wallet.balance.toFixed(0);
            localStorage.setItem('cp_wallet_v2', JSON.stringify(wallet));
        }

        function startCooldownTimer() {
            if(cooldownTimerInterval) clearInterval(cooldownTimerInterval);
            
            const checkTimer = () => {
                const now = Date.now();
                const last = wallet.lastCollect || 0;
                const diff = now - last;
                const btn = document.getElementById('collectBtn');
                const btnText = document.getElementById('collectBtnText');
                
                if (diff < COOLDOWN_MS) {
                    const remaining = COOLDOWN_MS - diff;
                    const hours = Math.floor(remaining / (1000 * 60 * 60));
                    const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                    
                    btn.classList.add('btn-disabled');
                    btnText.innerText = `Wait: ${hours}h ${minutes}m`;
                } else {
                    btn.classList.remove('btn-disabled');
                    btnText.innerText = 'Collect Rewards';
                }
            };

            checkTimer(); // Run immediately
            cooldownTimerInterval = setInterval(checkTimer, 60000); // Check every minute
        }

        function invest(farmerId, change) {
            const currentInvest = wallet.investments[farmerId] || 0;
            const currentInvestedCount = Object.keys(wallet.investments).length;

            if (change > 0) {
                if (wallet.balance < change) return showToast("Insufficient Funds", "error");
                if (currentInvest + change > MAX_INVEST_PER_FARMER) return showToast(`Max investment per farmer is ${MAX_INVEST_PER_FARMER} CP`, "error");
                if (currentInvest === 0 && currentInvestedCount >= MAX_FARMERS_INVESTED) return showToast(`Max ${MAX_FARMERS_INVESTED} different farmers allowed`, "error");
                
                wallet.balance -= change;
                wallet.investments[farmerId] = currentInvest + change;
                showToast(`Invested ${change} CP`, "gold");
            } else {
                if (currentInvest === 0) return;
                const withdrawAmount = Math.abs(change);
                if (withdrawAmount > currentInvest) return;

                wallet.balance += withdrawAmount;
                wallet.investments[farmerId] = currentInvest - withdrawAmount;
                if (wallet.investments[farmerId] === 0) delete wallet.investments[farmerId];
                showToast(`Withdrew ${withdrawAmount} CP`, "neutral");
            }

            updateWalletUI();
            
            const amountEl = document.getElementById(`invest-val-${farmerId}`);
            if(amountEl) amountEl.innerText = wallet.investments[farmerId] || 0;
        }

        function collectRewards() {
            const now = Date.now();
            const last = wallet.lastCollect || 0;
            
            // Check Cooldown
            if (now - last < COOLDOWN_MS) {
                showToast("Rewards already collected today. Please wait.", "error");
                return;
            }

            let totalProfit = 0;
            let log = [];

            // Calculate profit based on LATEST scores
            Object.keys(wallet.investments).forEach(farmerId => {
                const farmer = processedFarmers.find(f => f.id === farmerId);
                const investedAmount = wallet.investments[farmerId];

                if (farmer && farmer.scores.length > 0) {
                    const latestScore = farmer.scores[0].score;
                    const diff = latestScore - SCORE_THRESHOLD;
                    const profit = diff * investedAmount;
                    
                    totalProfit += profit;
                }
            });

            if (Object.keys(wallet.investments).length === 0) {
                return showToast("No active investments to collect from.", "neutral");
            }

            wallet.balance += totalProfit;
            if(wallet.balance < 0) wallet.balance = 0;
            
            // Update timestamp
            wallet.lastCollect = now;

            updateWalletUI();
            startCooldownTimer(); // Update button state immediately
            
            const emoji = totalProfit >= 0 ? 'ðŸ¤‘' : 'ðŸ’¸';
            showToast(`${emoji} Collected: ${totalProfit.toFixed(1)} CP`, totalProfit >= 0 ? "gold" : "error");
        }

        // --- RENDERING ---

        function renderLeaderboard() {
            const container = document.getElementById('view-container');
            container.innerHTML = `
                <div class="grid grid-cols-1 gap-4 animate-slide-up">
                    <div class="grid grid-cols-12 px-6 py-4 text-[10px] font-black uppercase tracking-widest text-slate-500">
                        <div class="col-span-1">Rank</div>
                        <div class="col-span-4">Farmer Profile</div>
                        <div class="col-span-2 text-center">Avg (14s)</div>
                        <div class="col-span-2 text-center">Latest</div>
                        <div class="col-span-1 text-center">Invested</div>
                        <div class="col-span-2 text-right">Compare</div>
                    </div>
                    ${processedFarmers.map((f, i) => {
                        const latest = f.scores[0];
                        const latestScore = latest ? latest.score : 0;
                        const latestColor = getTailwindColor(latestScore);
                        const isBestOfDay = latest && latest.score === dailyBestScores[latest.date];
                        const investedAmount = wallet.investments[f.id] || 0;

                        return `
                        <div class="glass-card grid grid-cols-12 items-center p-5 rounded-2xl cursor-pointer hover:bg-slate-800/50" onclick="renderProfile('${f.id}')">
                            <div class="col-span-1 font-black text-slate-500 text-lg italic">#${i + 1}</div>
                            
                            <div class="col-span-4 flex items-center gap-4">
                                <div class="w-12 h-12 rounded-xl bg-slate-800 flex items-center justify-center font-bold text-indigo-400 border border-slate-700 relative">
                                    ${f.name[0]}
                                    ${investedAmount > 0 ? `<div class="absolute -top-2 -right-2 bg-amber-500 text-white text-[8px] font-bold px-1.5 py-0.5 rounded-full border border-slate-900 shadow-sm">${investedAmount}</div>` : ''}
                                </div>
                                <div>
                                    <div class="font-bold text-white text-lg flex items-center gap-2">
                                        ${f.name}
                                        ${isBestOfDay ? '<i data-lucide="star" class="w-4 h-4 text-yellow-500 fill-yellow-500"></i>' : ''}
                                    </div>
                                    <div class="text-[10px] text-slate-500 uppercase font-bold tracking-tighter">${f.accolades[0] || 'Contributor'}</div>
                                </div>
                            </div>
                            
                            <div class="col-span-2 flex justify-center items-center gap-3">
                                <span class="text-xl font-black ${getTailwindColor(f.currentAvg)}">${f.currentAvg}</span>
                                ${getTrendIcon(f.trend)}
                            </div>

                            <div class="col-span-2 flex justify-center items-center">
                                <span class="text-lg font-black ${latestColor} bg-slate-800/50 px-3 py-1 rounded-lg border border-slate-700/50">
                                    ${latestScore.toFixed(1)}
                                </span>
                            </div>

                            <div class="col-span-1 flex justify-center">
                                ${investedAmount > 0 
                                    ? `<span class="text-amber-400 font-bold text-sm flex items-center gap-1"><i data-lucide="coins" class="w-3 h-3"></i> ${investedAmount}</span>` 
                                    : `<span class="text-slate-700 text-xs font-bold">-</span>`}
                            </div>
                            
                            <div class="col-span-2 text-right">
                                <button onclick="event.stopPropagation(); addToCompare('${f.id}')" class="p-2.5 hover:bg-indigo-500/20 rounded-xl text-slate-500 hover:text-indigo-400 transition border border-transparent hover:border-indigo-500/30">
                                    <i data-lucide="${compareSelection.includes(f.id) ? 'check-circle-2' : 'plus-circle'}" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
            lucide.createIcons();
        }

        function getTrendIcon(trend) {
            if (trend === 'up') return '<i data-lucide="arrow-up-right" class="w-4 h-4 text-emerald-400"></i>';
            if (trend === 'down') return '<i data-lucide="arrow-down-right" class="w-4 h-4 text-red-400"></i>';
            return '<i data-lucide="minus" class="w-4 h-4 text-slate-500"></i>';
        }

        function renderProfile(id) {
            const f = processedFarmers.find(x => x.id === id);
            const container = document.getElementById('view-container');
            const investedAmount = wallet.investments[f.id] || 0;
            
            container.innerHTML = `
                <div class="animate-slide-up pb-10">
                    <button onclick="renderLeaderboard()" class="mb-8 flex items-center gap-2 text-slate-400 hover:text-white transition font-bold text-sm uppercase tracking-widest">
                        <i data-lucide="chevron-left" class="w-4 h-4"></i> Back to Hub
                    </button>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1 space-y-6">
                            <div class="glass-card p-10 rounded-[2rem] text-center border-b-4 border-indigo-500 relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-full h-24 bg-gradient-to-b from-indigo-500/10 to-transparent"></div>
                                
                                <div class="w-24 h-24 rounded-3xl bg-indigo-600 mx-auto mb-6 flex items-center justify-center text-4xl font-black shadow-2xl shadow-indigo-500/40 relative z-10">${f.name[0]}</div>
                                <h2 class="text-3xl font-black mb-1 relative z-10">${f.name}</h2>
                                <p class="text-indigo-400 font-bold mb-8 uppercase tracking-widest text-xs relative z-10">${f.grade.label}</p>
                                
                                <div class="grid grid-cols-3 gap-3 relative z-10">
                                    <div class="bg-slate-900/80 p-3 rounded-2xl border border-slate-800">
                                        <span class="block text-[8px] text-slate-500 uppercase font-black mb-1">Mean</span>
                                        <span class="text-xl font-black ${getTailwindColor(f.currentAvg)}">${f.currentAvg}</span>
                                    </div>
                                    
                                    <div class="bg-slate-900/90 p-2 rounded-2xl border border-amber-500/30 shadow-lg shadow-amber-500/5 group">
                                        <span class="block text-[8px] text-amber-500 uppercase font-black mb-1 flex justify-center gap-1 items-center">
                                            Invest <i data-lucide="coins" class="w-3 h-3"></i>
                                        </span>
                                        <div class="flex items-center justify-between bg-slate-950 rounded-lg p-1">
                                            <button onclick="invest('${f.id}', -5)" class="w-6 h-6 flex items-center justify-center bg-slate-800 hover:bg-red-500/20 text-slate-400 hover:text-red-400 rounded-md transition font-bold">-</button>
                                            <span id="invest-val-${f.id}" class="font-black text-amber-100 text-lg">${investedAmount}</span>
                                            <button onclick="invest('${f.id}', 5)" class="w-6 h-6 flex items-center justify-center bg-slate-800 hover:bg-emerald-500/20 text-slate-400 hover:text-emerald-400 rounded-md transition font-bold">+</button>
                                        </div>
                                    </div>

                                    <div class="bg-slate-900/80 p-3 rounded-2xl border border-slate-800">
                                        <span class="block text-[8px] text-slate-500 uppercase font-black mb-1">Pulse</span>
                                        <div class="flex justify-center">${getTrendIcon(f.trend)}</div>
                                    </div>
                                </div>
                                <div class="mt-4 text-[10px] text-slate-500 font-medium">
                                    Payout: (Score - ${SCORE_THRESHOLD}) x Invest
                                </div>
                            </div>

                            <div class="glass-card p-6 rounded-3xl">
                                <h3 class="font-black text-xs uppercase tracking-[0.2em] text-slate-400 mb-6 flex items-center gap-2"><i data-lucide="history" class="w-4 h-4"></i> Score Library</h3>
                                <div class="space-y-2 max-h-[400px] overflow-y-auto custom-scroll pr-2">
                                    ${f.scores.map(s => `
                                        <div class="flex justify-between items-center p-3 bg-slate-900/40 rounded-xl border border-slate-800/50">
                                            <div class="flex items-center gap-3">
                                                <span class="text-xs font-bold text-slate-500">${s.date}</span>
                                                ${s.score === dailyBestScores[s.date] ? '<i data-lucide="star" class="w-3.5 h-3.5 text-yellow-500 fill-yellow-500"></i>' : ''}
                                            </div>
                                            <span class="font-black ${getTailwindColor(s.score)}">${s.score.toFixed(1)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-2 space-y-6">
                            <div class="glass-card p-8 rounded-3xl h-[400px]">
                                <h3 class="font-black text-xs uppercase tracking-[0.2em] text-slate-400 mb-6">Attribute DNA</h3>
                                <canvas id="attributeChart"></canvas>
                            </div>
                            <div class="glass-card p-8 rounded-3xl">
                                <h3 class="font-black text-xs uppercase tracking-[0.2em] text-slate-400 mb-6">Performance Trajectory (Bars)</h3>
                                <canvas id="historyChart" height="150"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            lucide.createIcons();
            initCharts(f);
        }

        function initCharts(f) {
            new Chart(document.getElementById('attributeChart'), {
                type: 'radar',
                data: {
                    labels: ['Creativity', 'Consistency', 'Attendance', 'Presence', 'Quality'],
                    datasets: [{
                        data: Object.values(f.attributes),
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        borderColor: '#6366f1',
                        pointBackgroundColor: '#6366f1',
                        borderWidth: 3
                    }]
                },
                options: {
                    scales: { r: { min: 0, max: 100, ticks: { display: false }, grid: { color: 'rgba(255,255,255,0.05)' }, angleLines: { color: 'rgba(255,255,255,0.1)' }, pointLabels: { color: '#64748b', font: { weight: 'bold', size: 10 } } } },
                    plugins: { legend: { display: false } }
                }
            });

            const histData = [...f.scores].reverse().slice(-10);
            new Chart(document.getElementById('historyChart'), {
                type: 'bar',
                data: {
                    labels: histData.map(s => s.date.slice(5)),
                    datasets: [{
                        data: histData.map(s => s.score),
                        backgroundColor: histData.map(s => getHexColor(s.score)),
                        borderRadius: 8
                    }]
                },
                options: {
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { min: 0, max: 10, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function addToCompare(id) {
            if (compareSelection.includes(id)) {
                compareSelection = compareSelection.filter(x => x !== id);
            } else {
                if (compareSelection.length >= 2) compareSelection.shift();
                compareSelection.push(id);
            }
            const btn = document.getElementById('compareBtn');
            btn.innerHTML = `<i data-lucide="swords" class="w-4 h-4"></i> Compare (${compareSelection.length})`;
            lucide.createIcons();
            renderLeaderboard();
        }

        function toggleCompareMode() {
            const modal = document.getElementById('compareModal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) renderComparison();
        }

        function renderComparison() {
            const content = document.getElementById('compareContent');
            if (compareSelection.length < 2) {
                content.innerHTML = `<div class="col-span-2 text-center py-20 text-slate-500 font-bold uppercase tracking-widest">Select two farmers to compare</div>`;
                return;
            }
            const f1 = processedFarmers.find(x => x.id === compareSelection[0]);
            const f2 = processedFarmers.find(x => x.id === compareSelection[1]);

            content.innerHTML = `
                <div class="space-y-6">${renderCompCard(f1)}</div>
                <div class="space-y-6">${renderCompCard(f2)}</div>
                <div class="col-span-1 md:col-span-2 glass-card p-8 rounded-3xl mt-4">
                    <canvas id="compareRadarChart" height="250"></canvas>
                </div>
            `;

            new Chart(document.getElementById('compareRadarChart'), {
                type: 'radar',
                data: {
                    labels: ['Creativity', 'Consistency', 'Attendance', 'Presence', 'Quality'],
                    datasets: [
                        { label: f1.name, data: Object.values(f1.attributes), borderColor: '#6366f1', backgroundColor: 'rgba(99, 102, 241, 0.2)' },
                        { label: f2.name, data: Object.values(f2.attributes), borderColor: '#f43f5e', backgroundColor: 'rgba(244, 63, 94, 0.2)' }
                    ]
                },
                options: { scales: { r: { min: 0, max: 100, ticks: { display: false }, grid: { color: 'rgba(255,255,255,0.1)' } } }, plugins: { legend: { labels: { color: '#fff', font: { weight: 'bold' } } } } }
            });
        }

        function renderCompCard(f) {
            return `
                <div class="flex items-center gap-6 mb-8">
                    <div class="w-20 h-20 rounded-2xl bg-slate-800 flex items-center justify-center text-3xl font-black border border-slate-700 text-indigo-400">${f.name[0]}</div>
                    <div>
                        <h3 class="text-3xl font-black text-white">${f.name}</h3>
                        <span class="grade-badge ${f.grade.color}">${f.grade.label}</span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-950 p-5 rounded-2xl border border-slate-800">
                        <span class="block text-[10px] text-slate-500 font-bold uppercase mb-1">Mean Score</span>
                        <span class="text-2xl font-black ${getTailwindColor(f.currentAvg)}">${f.currentAvg}</span>
                    </div>
                    <div class="bg-slate-950 p-5 rounded-2xl border border-slate-800">
                        <span class="block text-[10px] text-slate-500 font-bold uppercase mb-1">Quality Stat</span>
                        <span class="text-2xl font-black text-cyan-400">${f.attributes.quality}</span>
                    </div>
                </div>
            `;
        }

        window.onload = init;
    </script>
</body>
</html>
