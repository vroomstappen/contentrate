<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ContentRate Pro 3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.469.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: #f8fafc; min-height: 100vh; }
        .glass-card { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease; }
        .glass-card:hover { border: 1px solid rgba(99, 102, 241, 0.3); transform: translateY(-2px); }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.5s ease-out forwards; }
        .loading-spinner { border: 3px solid rgba(99, 102, 241, 0.1); border-top: 3px solid #6366f1; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }

        /* --- SIGNATURE KING CARD --- */
        .signature-card {
            position: relative;
            overflow: hidden;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 1)) !important;
            border: 1px solid rgba(251, 191, 36, 0.6) !important; /* Gold Border */
            box-shadow: 0 0 25px rgba(251, 191, 36, 0.2) !important;
        }

        .signature-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: -150%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.15),
                transparent
            );
            transform: skewX(-20deg);
            animation: shine 4s infinite linear;
            pointer-events: none;
        }

        @keyframes shine {
            0% { left: -150%; }
            40% { left: 150%; }
            100% { left: 150%; }
        }

        /* Rank Arrows */
        .rank-up { color: #34d399; font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; font-weight: 800; }
        .rank-down { color: #f87171; font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; font-weight: 800; }
        .rank-same { color: #64748b; font-size: 1rem; font-weight: 800; }

        /* --- TUTORIAL OVERLAY --- */
        #tutorialOverlay {
            position: fixed; inset: 0; background: rgba(2, 6, 23, 0.92);
            backdrop-filter: blur(8px); z-index: 100; align-items: center; justify-content: center;
        }
        #tutorialOverlay:not(.hidden) { display: flex; }
        .tutorial-card { animation: slideUp 0.5s ease-out forwards; }
        .tutorial-step { display: none; }
        .tutorial-step.active { display: block; }
        .tutorial-dot { width: 8px; height: 8px; border-radius: 50%; background: #334155; transition: all 0.3s; }
        .tutorial-dot.active { background: #6366f1; width: 20px; border-radius: 4px; }

        /* --- ACCOUNT / LEADERBOARD MODAL --- */
        #accountModal { position: fixed; inset: 0; background: rgba(2,6,23,0.95); backdrop-filter: blur(16px); z-index: 80; }
        .lb-row { transition: all 0.2s; }
        .lb-row:hover { background: rgba(99,102,241,0.08); }
        .lb-gold { border-left: 3px solid #f59e0b; }
        .lb-silver { border-left: 3px solid #94a3b8; }
        .lb-bronze { border-left: 3px solid #b45309; }

        /* --- NET WORTH BADGE --- */
        @keyframes pulse-glow { 0%,100% { box-shadow: 0 0 0 0 rgba(99,102,241,0.4); } 50% { box-shadow: 0 0 0 8px rgba(99,102,241,0); } }
        .nw-pulse { animation: pulse-glow 2s infinite; }

        /* --- STAT BARS --- */
        .stat-bar-track { height: 6px; background: rgba(255,255,255,0.05); border-radius: 99px; overflow: hidden; }
        .stat-bar-fill { height: 100%; border-radius: 99px; transition: width 0.8s cubic-bezier(0.4,0,0.2,1); }

        /* Compare win highlight */
        .compare-win { background: rgba(99,102,241,0.15) !important; border-color: rgba(99,102,241,0.4) !important; }
    </style>
</head>
<body class="p-4 md:p-10">

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col xl:flex-row justify-between items-center mb-10 gap-6">
            <div class="text-center xl:text-left">
                <h1 class="text-4xl font-extrabold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400">ContentRate <span class="text-white">Manager</span></h1>
                <p class="text-slate-500 font-medium">Describing content with numbers.</p>
            </div>

            <div class="glass-card px-6 py-3 rounded-2xl flex flex-wrap justify-center items-center gap-6 border border-amber-500/20 shadow-lg shadow-amber-900/10">
                <div class="flex flex-col items-end">
                    <span class="text-[10px] uppercase font-bold tracking-widest text-slate-400">Current CP</span>
                    <div class="flex items-center gap-2">
                        <i data-lucide="coins" class="w-5 h-5 text-amber-400 fill-amber-400"></i>
                        <span id="walletBalance" class="text-2xl font-black text-white">100</span>
                    </div>
                </div>
                <div class="h-8 w-px bg-slate-700"></div>
                <div class="flex flex-col items-end">
                    <span class="text-[10px] uppercase font-bold tracking-widest text-slate-400">Net Worth</span>
                    <div class="flex items-center gap-2">
                        <i data-lucide="briefcase" class="w-4 h-4 text-emerald-400"></i>
                        <span id="netWorth" class="text-xl font-bold text-emerald-400">--</span>
                    </div>
                </div>
                <div class="h-8 w-px bg-slate-700"></div>
                <div class="flex flex-col items-center">
                    <span class="text-[10px] uppercase font-bold tracking-widest text-slate-400">Roster</span>
                    <span id="rosterCount" class="text-xl font-black text-indigo-400">0/4</span>
                </div>
                <div class="h-8 w-px bg-slate-700"></div>
                <div class="flex gap-2">
                    <button onclick="collectRewards()" id="collectBtn" class="bg-amber-500/10 hover:bg-amber-500/20 text-amber-400 px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wider transition border border-amber-500/50 flex items-center gap-2">
                        <i data-lucide="play-circle" class="w-4 h-4"></i> 
                        <span id="collectBtnText">Run Daily Match</span>
                    </button>
                    <button onclick="resetAccount()" class="text-slate-600 hover:text-red-400 p-2 transition" title="Reset Career">
                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                    </button>
                    <button onclick="openTutorial()" class="text-slate-600 hover:text-yellow-400 p-2 transition" title="Tutorial">
                        <i data-lucide="lightbulb" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="relative hidden md:block">
                    <input type="text" id="searchInput" oninput="renderLeaderboard()" placeholder="Scout talent..." class="bg-slate-900 border border-slate-700 rounded-xl px-4 py-2 text-sm focus:outline-none focus:border-indigo-500 transition w-48 text-white">
                </div>
                <button onclick="openAccountModal()" class="px-4 py-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 transition flex items-center gap-2 text-sm font-bold border border-slate-700 hover:border-indigo-500/50">
                    <i data-lucide="trophy" class="w-4 h-4 text-amber-400"></i>
                    <span class="hidden sm:inline text-slate-300">Leaderboard</span>
                </button>
                <button onclick="toggleCompareMode()" id="compareBtn" class="px-6 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 transition flex items-center gap-2 text-sm font-bold shadow-lg shadow-indigo-500/20">
                    <i data-lucide="swords" class="w-4 h-4"></i> Compare
                </button>
            </div>
        </header>

        <div id="loading-state" class="flex flex-col items-center justify-center py-20">
            <div class="loading-spinner mb-4"></div>
            <p class="text-slate-500 font-bold animate-pulse">SCOUTING DATABASE...</p>
        </div>

        <main id="view-container" class="hidden"></main>
    </div>

    <!-- ===== TUTORIAL OVERLAY ===== -->
    <div id="tutorialOverlay" class="hidden">
        <div class="tutorial-card bg-slate-900 border border-slate-700 rounded-3xl w-full max-w-lg mx-4 p-8 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <span class="text-[10px] font-black uppercase tracking-widest text-indigo-400">ContentRate Manager</span>
                <button onclick="closeTutorial()" class="text-slate-500 hover:text-white transition"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>

            <!-- Steps -->
            <div id="tutStep0" class="tutorial-step active">
                <div class="text-5xl mb-4">üëã</div>
                <h2 class="text-2xl font-black text-white mb-3">Welcome to ContentRate Manager</h2>
                <p class="text-slate-400 leading-relaxed">This is a fantasy-style investing game built around real content creator scores. You'll build a roster, run daily matches, and grow your CP (ContentPoints) balance.</p>
            </div>
            <div id="tutStep1" class="tutorial-step">
                <div class="text-5xl mb-4">üìä</div>
                <h2 class="text-2xl font-black text-white mb-3">The Leaderboard</h2>
                <p class="text-slate-400 leading-relaxed">Browse all creators ranked by their 14-day average score. Each card shows their current form, trend, and recruitment cost. Click a card to see their full profile and match history.</p>
            </div>
            <div id="tutStep2" class="tutorial-step">
                <div class="text-5xl mb-4">‚≠ê</div>
                <h2 class="text-2xl font-black text-white mb-3">What's the Star?</h2>
                <p class="text-slate-400 leading-relaxed">A <span class="text-yellow-400 font-bold">‚òÖ gold star</span> means that creator had the highest score out of everyone on that particular day. It's a daily "best performer" badge ‚Äî a creator can earn multiple stars across different days.</p>
            </div>
            <div id="tutStep3" class="tutorial-step">
                <div class="text-5xl mb-4">üëë</div>
                <h2 class="text-2xl font-black text-white mb-3">What's the Crown?</h2>
                <p class="text-slate-400 leading-relaxed">The <span class="text-amber-400 font-bold">üëë crown</span> marks the current <strong class="text-white">King</strong> ‚Äî whoever has the best form right now based on their last 5 scores. Only one creator holds the crown at a time, and it changes as scores update.</p>
            </div>
            <div id="tutStep4" class="tutorial-step">
                <div class="text-5xl mb-4">üî¢</div>
                <h2 class="text-2xl font-black text-white mb-3">Form Points Explained</h2>
                <p class="text-slate-400 leading-relaxed mb-3">Form Points are calculated from a creator's last 5 scores using their colour band:</p>
                <div class="grid grid-cols-2 gap-1.5 text-xs font-bold">
                    <div class="flex items-center gap-2 bg-purple-500/10 border border-purple-500/30 rounded-lg px-3 py-1.5"><span class="text-purple-400">Purple (‚â•9.0)</span><span class="ml-auto text-white">+4</span></div>
                    <div class="flex items-center gap-2 bg-blue-500/10 border border-blue-500/30 rounded-lg px-3 py-1.5"><span class="text-blue-400">Blue (8.0‚Äì8.99)</span><span class="ml-auto text-white">+2</span></div>
                    <div class="flex items-center gap-2 bg-green-500/10 border border-green-500/30 rounded-lg px-3 py-1.5"><span class="text-green-400">Green (7.0‚Äì7.99)</span><span class="ml-auto text-white">+1</span></div>
                    <div class="flex items-center gap-2 bg-yellow-500/10 border border-yellow-500/30 rounded-lg px-3 py-1.5"><span class="text-yellow-400">Yellow (6.5‚Äì6.99)</span><span class="ml-auto text-white">0</span></div>
                    <div class="flex items-center gap-2 bg-orange-500/10 border border-orange-500/30 rounded-lg px-3 py-1.5"><span class="text-orange-400">Orange (6.0‚Äì6.49)</span><span class="ml-auto text-white">‚àí1</span></div>
                    <div class="flex items-center gap-2 bg-red-500/10 border border-red-500/30 rounded-lg px-3 py-1.5"><span class="text-red-400">Red (&lt;6.0)</span><span class="ml-auto text-white">‚àí2</span></div>
                </div>
            </div>
            <div id="tutStep5" class="tutorial-step">
                <div class="text-5xl mb-4">ü§ù</div>
                <h2 class="text-2xl font-black text-white mb-3">Recruit Your Roster</h2>
                <p class="text-slate-400 leading-relaxed">Spend CP to recruit creators (up to 4 slots). Higher-rated creators cost more but earn bigger rewards. You can release them anytime to recoup their value.</p>
            </div>
            <div id="tutStep6" class="tutorial-step">
                <div class="text-5xl mb-4">üèÜ</div>
                <h2 class="text-2xl font-black text-white mb-3">Run Daily Matches</h2>
                <p class="text-slate-400 leading-relaxed">Hit <strong class="text-amber-400">Run Daily Match</strong> once per day. Your creators' latest scores determine your payout. A score ‚â•9.0 is a jackpot, ‚â•8.0 earns profit, and &lt;6.5 is a penalty.</p>
            </div>
            <div id="tutStep7" class="tutorial-step">
                <div class="text-5xl mb-4">ü•á</div>
                <h2 class="text-2xl font-black text-white mb-3">Global Leaderboard & Compare</h2>
                <p class="text-slate-400 leading-relaxed">Create an account to appear on the <strong class="text-amber-400">global leaderboard</strong> ‚Äî your net worth is ranked against all other managers and others can see your roster. Use <strong class="text-indigo-400">Compare</strong> for a deep head-to-head breakdown of any two creators.</p>
            </div>

            <!-- Nav -->
            <div class="flex items-center justify-between mt-8">
                <div class="flex gap-2" id="tutDots"></div>
                <div class="flex gap-3">
                    <button onclick="tutPrev()" id="tutPrevBtn" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-400 text-sm font-bold transition hidden">Back</button>
                    <button onclick="tutNext()" id="tutNextBtn" class="px-5 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-bold transition">Next ‚Üí</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== ACCOUNT / GLOBAL LEADERBOARD MODAL ===== -->
    <div id="accountModal" class="hidden flex flex-col">
        <div class="max-w-4xl w-full mx-auto p-4 md:p-8 flex flex-col h-full overflow-y-auto">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black text-white flex items-center gap-3"><i data-lucide="trophy" class="w-6 h-6 text-amber-400"></i> Global Manager Leaderboard</h2>
                <button onclick="closeAccountModal()" class="p-2 hover:bg-slate-800 rounded-full transition text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>

            <!-- Auth / Profile panel -->
            <div id="accountPanel" class="glass-card p-6 rounded-2xl mb-6"></div>

            <!-- Leaderboard table -->
            <div class="glass-card rounded-2xl overflow-hidden">
                <div class="p-5 border-b border-slate-800 flex items-center justify-between">
                    <span class="text-xs font-black uppercase tracking-widest text-slate-400">All Managers</span>
                    <span id="lbLastUpdated" class="text-[10px] text-slate-600"></span>
                </div>
                <div id="globalLbList" class="divide-y divide-slate-800/60 max-h-[50vh] overflow-y-auto custom-scroll">
                    <div class="p-8 text-center text-slate-500 font-bold text-sm">Loading leaderboard...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="compareModal" class="fixed inset-0 bg-slate-950/95 backdrop-blur-xl z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-800 w-full max-w-6xl rounded-3xl overflow-y-auto max-h-[95vh] shadow-2xl custom-scroll relative">
            <div class="sticky top-0 bg-slate-900/90 backdrop-blur-md p-6 border-b border-slate-800 flex justify-between items-center z-20">
                <h2 class="text-xl font-bold flex items-center gap-2 text-indigo-400">Head-to-Head Analysis</h2>
                <button onclick="toggleCompareMode()" class="p-2 hover:bg-slate-800 rounded-full transition"><i data-lucide="x"></i></button>
            </div>
            <div class="p-8" id="compareContent"></div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 right-10 bg-slate-800 border border-slate-700 text-white px-6 py-4 rounded-xl shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 font-bold flex items-center gap-3">
        <span id="toastMsg">Notification</span>
    </div>

    <script>
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSMTqwP3ViGcOKh0lYRGL9rdAL-Q84U85iZSLTqwdT3OGXKhMvIsI-pNC_cbRjcod0teMJ7YbRXREhy/pub?gid=607342177&single=true&output=csv';
        const MAX_ROSTER_SIZE = 4;
        const COOLDOWN_MS = 24 * 60 * 60 * 1000; 

        let processedFarmers = [];
        let compareSelection = [];
        let dailyBestScores = {};
        let cooldownTimerInterval;
        
        let wallet = {
            balance: 100,
            roster: [],
            lastCollect: 0
        };

        function getHexColor(score) {
            if (score <= 5.99) return '#ef4444';
            if (score <= 6.49) return '#f97316';
            if (score <= 6.99) return '#eab308';
            if (score <= 7.99) return '#22c55e';
            if (score <= 8.99) return '#3b82f6';
            return '#a855f7';
        }

        function getTailwindColor(score) {
            if (score <= 5.99) return 'text-red-500';
            if (score <= 6.49) return 'text-orange-500';
            if (score <= 6.99) return 'text-yellow-500';
            if (score <= 7.99) return 'text-green-500';
            if (score <= 8.99) return 'text-blue-500';
            return 'text-purple-500';
        }

        function getScoreBgColor(score) {
            if (score <= 5.99) return 'bg-red-500';
            if (score <= 6.49) return 'bg-orange-500';
            if (score <= 6.99) return 'bg-yellow-500';
            if (score <= 7.99) return 'bg-emerald-500';
            if (score <= 8.99) return 'bg-blue-500';
            return 'bg-purple-500';
        }

        function showToast(msg, type = 'neutral') {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toastMsg');
            msgEl.innerHTML = msg;
            
            let color = 'border-slate-700';
            if(type === 'success') color = 'border-emerald-500 text-emerald-400';
            if(type === 'error') color = 'border-red-500 text-red-400';
            if(type === 'gold') color = 'border-amber-500 text-amber-400';
            
            toast.className = `fixed bottom-10 right-10 bg-slate-900 border ${color} px-6 py-4 rounded-xl shadow-2xl transform translate-y-0 opacity-100 transition-all duration-300 z-50 font-bold flex items-center gap-3`;
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        // --- DATA PROTECTION INIT ---
        async function init() {
            loadAccountUser();

            // Show tutorial on first ever visit
            if (!localStorage.getItem('cr_tutorial_done')) {
                openTutorial();
            }

            // Check for the NEW key logic first
            let savedWallet = localStorage.getItem('cp_manager_king_v1');
            
            // If new key doesn't exist, check for the OLD key (Migration)
            if (!savedWallet) {
                savedWallet = localStorage.getItem('cp_manager_save_v5_safezone'); 
            }

            if (savedWallet) {
                wallet = JSON.parse(savedWallet);
            }
            startCooldownTimer();

            try {
                const response = await fetch(SHEET_URL);
                const csvData = await response.text();
                Papa.parse(csvData, {
                    header: true,
                    dynamicTyping: true,
                    complete: (results) => { processSheetData(results.data); }
                });
            } catch (error) {
                document.getElementById('loading-state').innerHTML = `<p class="text-red-400 font-bold">Connection Failed.</p>`;
            }
        }

        function processSheetData(rows) {
            const farmersMap = {};

            rows.forEach(row => {
                if (!row.Name) return;
                if (!farmersMap[row.Name]) {
                    farmersMap[row.Name] = {
                        id: row.Name.toLowerCase().replace(/\s/g, '-'),
                        name: row.Name,
                        scores: [],
                        attributes: { creativity: row.Creativity || 70, consistency: row.Consistency || 70, attendance: row.Attendance || 70, presence: row.Presence || 70, quality: row.Quality || 70 }
                    };
                }
                farmersMap[row.Name].scores.push({ date: row.Date, score: parseFloat(row.Score) });
                if (!dailyBestScores[row.Date] || row.Score > dailyBestScores[row.Date]) {
                    dailyBestScores[row.Date] = row.Score;
                }
            });

            // 1. Process Basic Stats
            let tempFarmers = Object.values(farmersMap).map(f => {
                f.scores.sort((a, b) => new Date(b.date) - new Date(a.date));
                const recentScores = f.scores.slice(0, 14);
                const avg = recentScores.reduce((a, b) => a + b.score, 0) / recentScores.length;
                
                // Calculate PREVIOUS Average (Rolling) for rank change detection
                const prevScores = f.scores.slice(1, 15);
                const prevAvg = prevScores.length > 0 ? prevScores.reduce((a, b) => a + b.score, 0) / prevScores.length : avg;
                
                const currentAvg = parseFloat(avg.toFixed(2));
                const prevAvgFixed = parseFloat(prevAvg.toFixed(2));
                
                // Form Points (Last 5 Scores ‚Äî based on score colour bands)
                // Purple ‚â•9.0: +4 | Blue 8.0‚Äì8.99: +2 | Green 7.0‚Äì7.99: +1
                // Yellow 6.5‚Äì6.99: 0 | Orange 6.0‚Äì6.49: -1 | Red <6.0: -2
                const last5 = f.scores.slice(0, 5);
                const last5Avg = last5.reduce((a,b)=>a+b.score,0) / last5.length;
                let formPoints = 0;
                last5.forEach(s => {
                    if (s.score >= 9.0)       formPoints += 4;  // purple
                    else if (s.score >= 8.0)  formPoints += 2;  // blue
                    else if (s.score >= 7.0)  formPoints += 1;  // green
                    else if (s.score >= 6.5)  formPoints += 0;  // yellow
                    else if (s.score >= 6.0)  formPoints -= 1;  // orange
                    else                      formPoints -= 2;  // red
                });

                // Calculate Star Count
                let starCount = 0;
                f.scores.forEach(s => {
                    if(dailyBestScores[s.date] && s.score >= dailyBestScores[s.date]) {
                        starCount++;
                    }
                });

                // Calculate Profit Rate (Percentage of games with profit > 0)
                // Profit threshold is 7.0 score based on standard rules
                const profitGames = recentScores.filter(s => s.score >= 7.0).length;
                const profitRate = Math.round((profitGames / recentScores.length) * 100);

                // Rolling History for Charts
                let rollingHistory = [];
                for(let i=0; i<5; i++) {
                    const slice = f.scores.slice(i, i+14);
                    if(slice.length > 0) rollingHistory.push(parseFloat((slice.reduce((a, b) => a + b.score, 0) / slice.length).toFixed(2)));
                    else rollingHistory.push(null);
                }

                return {
                    ...f,
                    currentAvg, prevAvg: prevAvgFixed, formPoints, last5Avg, 
                    trend: avg > prevAvg ? 'up' : avg < prevAvg ? 'down' : 'equal',
                    grade: calculateGrade(avg),
                    stats: { 
                        best14: Math.max(...recentScores.map(s=>s.score)), 
                        worst14: Math.min(...recentScores.map(s=>s.score)), 
                        rollingHistory,
                        starCount,
                        profitRate
                    },
                    isKing: false
                };
            });

            // 2. Determine "The King" (Best Farmer Logic)
            const kingSort = [...tempFarmers].sort((a, b) => {
                if (b.formPoints !== a.formPoints) return b.formPoints - a.formPoints;
                if (b.last5Avg !== a.last5Avg) return b.last5Avg - a.last5Avg;
                return a.name.localeCompare(b.name);
            });
            if(kingSort.length > 0) {
                const kingID = kingSort[0].id;
                const kingRef = tempFarmers.find(f => f.id === kingID);
                if(kingRef) kingRef.isKing = true;
            }

            // 3. Determine Rank Changes
            tempFarmers.sort((a, b) => b.currentAvg - a.currentAvg);
            const prevRankList = [...tempFarmers].sort((a, b) => b.prevAvg - a.prevAvg);
            
            tempFarmers.forEach((f, index) => {
                const currentRank = index;
                const prevRank = prevRankList.findIndex(x => x.id === f.id);
                f.rankChange = prevRank - currentRank; 
            });

            // 4. Calculate Prices (STRICT FORMULA, NO FIXING)
            tempFarmers.forEach(f => {
                const basePrice = Math.max(10, Math.floor((f.currentAvg - 6.0) * 40));
                let multiplier = 1.0;
                if (f.isKing) multiplier = 1.2; 
                f.price = Math.floor(basePrice * multiplier);
            });

            processedFarmers = tempFarmers;
            updateHUD();
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('view-container').classList.remove('hidden');
            renderLeaderboard();
        }

        function calculateGrade(score) {
            if (score >= 8.0) return { label: 'S-Tier', color: 'bg-purple-500/10 text-purple-400 border-purple-500/30' };
            if (score >= 7.5) return { label: 'A-Tier', color: 'bg-indigo-500/10 text-indigo-400 border-indigo-500/30' };
            if (score >= 6.5) return { label: 'B-Tier', color: 'bg-emerald-500/10 text-emerald-400 border-emerald-500/30' };
            return { label: 'C-Tier', color: 'bg-slate-500/10 text-slate-400 border-slate-500/30' };
        }

        function updateHUD() {
            document.getElementById('walletBalance').innerText = wallet.balance.toFixed(0);
            const rosterEl = document.getElementById('rosterCount');
            rosterEl.innerText = `${wallet.roster.length}/${MAX_ROSTER_SIZE}`;
            rosterEl.className = wallet.roster.length >= MAX_ROSTER_SIZE ? 'text-xl font-black text-red-400' : 'text-xl font-black text-indigo-400';
            let assetValue = 0;
            wallet.roster.forEach(id => { const f = processedFarmers.find(x => x.id === id); if (f) assetValue += f.price; });
            document.getElementById('netWorth').innerText = (wallet.balance + assetValue).toFixed(0);
            localStorage.setItem('cp_manager_king_v1', JSON.stringify(wallet));
        }

        function resetAccount() {
            if(confirm("Are you sure? This will wipe your team and reset CP to 100.")) {
                localStorage.removeItem('cp_manager_king_v1');
                localStorage.removeItem('cp_manager_save_v5_safezone'); 
                location.reload();
            }
        }

        function startCooldownTimer() {
            if(cooldownTimerInterval) clearInterval(cooldownTimerInterval);
            const checkTimer = () => {
                const diff = Date.now() - (wallet.lastCollect || 0);
                const btn = document.getElementById('collectBtn');
                const btnText = document.getElementById('collectBtnText');
                if (diff < COOLDOWN_MS) {
                    const remaining = COOLDOWN_MS - diff;
                    btn.classList.add('btn-disabled');
                    btnText.innerText = `${Math.floor(remaining/3600000)}h ${Math.floor((remaining%3600000)/60000)}m`;
                } else {
                    btn.classList.remove('btn-disabled');
                    btnText.innerText = 'Run Daily Match';
                }
            };
            checkTimer();
            cooldownTimerInterval = setInterval(checkTimer, 60000);
        }

        function handleRecruit(farmerId) {
            const farmer = processedFarmers.find(f => f.id === farmerId);
            const isOwned = wallet.roster.includes(farmerId);
            if (isOwned) {
                wallet.balance += farmer.price;
                wallet.roster = wallet.roster.filter(id => id !== farmerId);
                showToast(`Sold ${farmer.name} for ${farmer.price} CP`, "neutral");
            } else {
                if (wallet.roster.length >= MAX_ROSTER_SIZE) return showToast(`Roster Full`, "error");
                if (wallet.balance < farmer.price) return showToast(`Insufficient CP`, "error");
                wallet.balance -= farmer.price;
                wallet.roster.push(farmerId);
                showToast(`Recruited ${farmer.name}!`, "gold");
            }
            updateHUD();
            if(document.getElementById('searchInput')) renderLeaderboard();
            const profileHeader = document.querySelector('#view-container h2');
            if(profileHeader && profileHeader.innerText.includes(farmer.name)) renderProfile(farmerId);
        }

        function collectRewards() {
            const now = Date.now();
            if (now - (wallet.lastCollect || 0) < COOLDOWN_MS) return showToast("Already played today.", "error");
            if (wallet.roster.length === 0) return showToast("Recruit players first!", "neutral");
            
            let totalChange = 0;
            wallet.roster.forEach(id => {
                const f = processedFarmers.find(x => x.id === id);
                if (f && f.scores.length > 0) {
                    const score = f.scores[0].score;
                    if (score >= 9.0) totalChange += 40;
                    else if (score >= 8.0) totalChange += 20;
                    else if (score >= 7.0) totalChange += (score - 7.0) * 15;
                    else if (score < 6.5) totalChange -= 15;
                }
            });
            wallet.balance += totalChange;
            if(wallet.balance < 0) wallet.balance = 0;
            wallet.lastCollect = now;
            updateHUD();
            startCooldownTimer();
            const emoji = totalChange >= 50 ? 'üöÄ' : (totalChange >= 0 ? 'ü§ë' : 'üìâ');
            showToast(`${emoji} Matchday: ${totalChange >= 0 ? '+' : ''}${totalChange.toFixed(1)} CP`, totalChange >= 0 ? 'gold' : 'error');
            // Auto-publish score to leaderboard after each match
            silentPublish();
        }

        function getRankArrow(change) {
            if (change > 0) return `<div class="rank-up"><i data-lucide="chevron-up" class="w-3 h-3"></i>+${change}</div>`;
            if (change < 0) return `<div class="rank-down"><i data-lucide="chevron-down" class="w-3 h-3"></i>${change}</div>`;
            return `<div class="rank-same">-</div>`;
        }

        function renderLeaderboard() {
            const query = document.getElementById('searchInput') ? document.getElementById('searchInput').value.toLowerCase() : '';
            const container = document.getElementById('view-container');
            const filtered = processedFarmers.filter(f => f.name.toLowerCase().includes(query));

            container.innerHTML = `
                <div class="grid grid-cols-1 gap-4 animate-slide-up">
                    <div class="hidden md:grid grid-cols-12 px-6 py-4 text-[10px] font-black uppercase tracking-widest text-slate-500">
                        <div class="col-span-1">Rank</div>
                        <div class="col-span-4">Farmer Profile</div>
                        <div class="col-span-2 text-center">Avg & Form</div>
                        <div class="col-span-2 text-center">Cost</div>
                        <div class="col-span-2 text-center">Latest</div>
                        <div class="col-span-1 text-right">Actions</div>
                    </div>
                    ${filtered.map((f, i) => {
                        const latest = f.scores[0];
                        const latestScore = latest ? latest.score : 0;
                        const isOwned = wallet.roster.includes(f.id);
                        const isBestOfDay = latest && latest.score === dailyBestScores[latest.date];
                        const last5 = f.scores.slice(0, 5).reverse();
                        const cardClass = f.isKing ? 'glass-card signature-card' : 'glass-card';

                        return `
                        <div class="${cardClass} grid grid-cols-12 items-center p-5 rounded-2xl cursor-pointer hover:bg-slate-800/50 group" onclick="renderProfile('${f.id}')">
                            <div class="col-span-2 md:col-span-1 font-black text-slate-500 text-lg italic flex flex-col items-center justify-center">
                                #${i + 1}
                                ${getRankArrow(f.rankChange)}
                            </div>
                            
                            <div class="col-span-6 md:col-span-4 flex items-center gap-4">
                                <div class="w-12 h-12 rounded-xl bg-slate-800 flex items-center justify-center font-bold text-indigo-400 border border-slate-700 text-xl relative">
                                    ${f.name[0]}
                                    ${isOwned ? `<div class="absolute -top-1 -right-1 bg-emerald-500 text-white w-4 h-4 rounded-full flex items-center justify-center border border-slate-900 shadow-sm"><i data-lucide="check" class="w-2 h-2"></i></div>` : ''}
                                </div>
                                <div>
                                    <div class="font-bold text-white text-lg flex items-center gap-2">
                                        ${f.name}
                                        ${isBestOfDay ? '<i data-lucide="star" class="w-4 h-4 text-yellow-500 fill-yellow-500"></i>' : ''}
                                        ${f.isKing ? '<i data-lucide="crown" class="w-4 h-4 text-amber-400 fill-amber-400"></i>' : ''}
                                    </div>
                                    <div class="text-[10px] text-slate-500 uppercase font-bold tracking-tighter">Contributor</div>
                                </div>
                            </div>
                            
                            <div class="col-span-4 md:col-span-2 flex flex-col justify-center items-end md:items-center">
                                <div class="flex items-center gap-2">
                                    <span class="text-xl font-black ${getTailwindColor(f.currentAvg)}">${f.currentAvg}</span>
                                    ${getTrendIcon(f.trend)}
                                </div>
                                <div class="flex gap-1 mt-1">
                                    ${last5.map(s => `<div class="w-2 h-2 rounded-sm ${getScoreBgColor(s.score)}" title="${s.score} (${s.date})"></div>`).join('')}
                                </div>
                            </div>

                            <div class="hidden md:flex col-span-2 justify-center items-center gap-1">
                                <span class="text-lg font-black text-amber-400">${f.price}</span>
                                <span class="text-xs text-amber-500/50 font-bold">CP</span>
                            </div>

                            <div class="hidden md:flex col-span-2 justify-center">
                                <span class="text-lg font-black ${getTailwindColor(latestScore)} bg-slate-800/50 px-3 py-1 rounded-lg border border-slate-700/50">${latestScore.toFixed(1)}</span>
                            </div>

                            <div class="hidden md:flex col-span-1 justify-end gap-2">
                                <button onclick="event.stopPropagation(); addToCompare('${f.id}')" class="p-2 rounded-lg transition hover:bg-slate-700 text-slate-500 hover:text-indigo-400" title="Compare">
                                    <i data-lucide="${compareSelection.includes(f.id) ? 'check-circle' : 'swords'}" class="w-5 h-5"></i>
                                </button>
                                <button onclick="event.stopPropagation(); handleRecruit('${f.id}')" class="p-2 rounded-lg transition ${isOwned ? 'bg-red-500/10 text-red-400 hover:bg-red-500/20' : 'bg-emerald-500/10 text-emerald-400 hover:bg-emerald-500/20'}">
                                    <i data-lucide="${isOwned ? 'x' : 'user-plus'}" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
            lucide.createIcons();
        }

        function renderProfile(id) {
            const f = processedFarmers.find(x => x.id === id);
            const container = document.getElementById('view-container');
            const isOwned = wallet.roster.includes(f.id);
            const isComparing = compareSelection.includes(f.id);
            const cardClass = f.isKing ? 'glass-card signature-card' : 'glass-card';
            
            container.innerHTML = `
                <div class="animate-slide-up pb-10">
                    <button onclick="renderLeaderboard()" class="mb-8 flex items-center gap-2 text-slate-400 hover:text-white transition font-bold text-sm uppercase tracking-widest">
                        <i data-lucide="chevron-left" class="w-4 h-4"></i> Back to Database
                    </button>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1 space-y-6">
                            <div class="${cardClass} p-8 rounded-[2rem] text-center border-b-4 ${isOwned ? 'border-emerald-500' : 'border-indigo-500'}">
                                <div class="w-24 h-24 rounded-3xl bg-indigo-600 mx-auto mb-6 flex items-center justify-center text-4xl font-black shadow-2xl shadow-indigo-500/40 relative">
                                    ${f.name[0]}
                                    ${isOwned ? `<div class="absolute -top-2 -right-2 bg-emerald-500 text-white px-3 py-1 text-xs font-bold rounded-full border-4 border-slate-900 shadow-sm">OWNED</div>` : ''}
                                </div>
                                <h2 class="text-3xl font-black mb-1 flex items-center justify-center gap-2">
                                    ${f.name}
                                    ${f.isKing ? '<i data-lucide="crown" class="w-6 h-6 text-amber-400 fill-amber-400"></i>' : ''}
                                </h2>
                                <p class="text-indigo-400 font-bold mb-6 uppercase tracking-widest text-xs">${f.grade.label}</p>
                                <div class="grid grid-cols-2 gap-3 mb-6">
                                    <div class="bg-slate-900/50 p-3 rounded-2xl border border-slate-800">
                                        <span class="block text-[8px] text-slate-500 uppercase font-black mb-1">Valuation</span>
                                        <span class="text-xl font-black text-amber-400">${f.price} CP</span>
                                    </div>
                                    <div class="bg-slate-900/50 p-3 rounded-2xl border border-slate-800">
                                        <span class="block text-[8px] text-slate-500 uppercase font-black mb-1">Mean</span>
                                        <span class="text-xl font-black ${getTailwindColor(f.currentAvg)}">${f.currentAvg}</span>
                                    </div>
                                </div>
                                <div class="text-[10px] text-slate-500 mb-4 bg-slate-900/50 p-2 rounded-lg">Payout: >9.0 Jackpot, >8.0 Profit, &lt;6.5 Penalty</div>
                                <div class="flex gap-3">
                                    <button onclick="addToCompare('${f.id}')" class="flex-1 py-4 rounded-xl font-black uppercase tracking-widest text-xs transition shadow-lg flex items-center justify-center gap-2 ${isComparing ? 'bg-indigo-500 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}">
                                        <i data-lucide="${isComparing ? 'check' : 'swords'}" class="w-4 h-4"></i> ${isComparing ? 'Selected' : 'Compare'}
                                    </button>
                                    <button onclick="handleRecruit('${f.id}')" class="flex-[2] py-4 rounded-xl font-black uppercase tracking-widest text-xs transition shadow-lg flex items-center justify-center gap-2 ${isOwned ? 'bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/50' : 'bg-emerald-500 hover:bg-emerald-400 text-white shadow-emerald-500/20'}">
                                        <i data-lucide="${isOwned ? 'user-minus' : 'user-plus'}" class="w-4 h-4"></i> ${isOwned ? `Release (+${f.price})` : `Recruit (-${f.price})`}
                                    </button>
                                </div>
                            </div>
                            <div class="glass-card p-6 rounded-3xl">
                                <h3 class="font-black text-xs uppercase tracking-[0.2em] text-slate-400 mb-6 flex items-center gap-2"><i data-lucide="history" class="w-4 h-4"></i> Match History</h3>
                                <div class="space-y-2 max-h-[300px] overflow-y-auto custom-scroll pr-2">
                                    ${f.scores.map(s => `<div class="flex justify-between items-center p-3 bg-slate-900/40 rounded-xl border border-slate-800/50"><div class="flex items-center gap-3"><span class="text-xs font-bold text-slate-500">${s.date}</span>${s.score === dailyBestScores[s.date] ? '<i data-lucide="star" class="w-3.5 h-3.5 text-yellow-500 fill-yellow-500"></i>' : ''}</div><span class="font-black ${getTailwindColor(s.score)}">${s.score.toFixed(1)}</span></div>`).join('')}
                                </div>
                            </div>
                        </div>
                        <div class="lg:col-span-2 space-y-6">
                            <div class="glass-card p-8 rounded-3xl h-[400px]"><h3 class="font-black text-xs uppercase tracking-[0.2em] text-slate-400 mb-6">Attribute DNA</h3><canvas id="attributeChart"></canvas></div>
                            <div class="glass-card p-8 rounded-3xl"><h3 class="font-black text-xs uppercase tracking-[0.2em] text-slate-400 mb-6">Performance Trajectory</h3><canvas id="historyChart" height="150"></canvas></div>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
            initCharts(f);
        }

        function addToCompare(id) {
            if (compareSelection.includes(id)) compareSelection = compareSelection.filter(x => x !== id);
            else { if (compareSelection.length >= 2) compareSelection.shift(); compareSelection.push(id); }
            document.getElementById('compareBtn').innerHTML = `<i data-lucide="swords" class="w-4 h-4"></i> Compare (${compareSelection.length})`;
            const profileHeader = document.querySelector('#view-container h2');
            const f = processedFarmers.find(x => x.id === id);
            if(profileHeader && profileHeader.innerText.includes(f.name)) renderProfile(id);
            else renderLeaderboard();
        }

        function toggleCompareMode() {
            const modal = document.getElementById('compareModal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) renderComparison();
        }

        function renderComparison() {
            const content = document.getElementById('compareContent');
            if (compareSelection.length < 2) { content.innerHTML = `<div class="text-center py-20 text-slate-500 font-bold uppercase tracking-widest">Select two farmers to compare</div>`; return; }
            const f1 = processedFarmers.find(x => x.id === compareSelection[0]);
            const f2 = processedFarmers.find(x => x.id === compareSelection[1]);

            // Helper: who wins each stat
            const wins = (v1, v2, higher = true) => higher ? v1 > v2 : v1 < v2;

            // Build stat row HTML
            const statRow = (label, v1, v2, higher = true, format = x => x) => {
                const w1 = wins(v1, v2, higher);
                const w2 = wins(v2, v1, higher);
                return `
                    <div class="flex items-center gap-3 py-2 border-b border-slate-800/50">
                        <div class="flex-1 text-right">
                            <span class="font-black ${w1 ? 'text-white' : 'text-slate-500'}">${format(v1)}</span>
                            ${w1 ? '<i data-lucide="check-circle" class="w-3 h-3 text-indigo-400 inline ml-1"></i>' : ''}
                        </div>
                        <div class="w-28 text-center text-[10px] font-black uppercase tracking-wider text-slate-500 shrink-0">${label}</div>
                        <div class="flex-1 text-left">
                            ${w2 ? '<i data-lucide="check-circle" class="w-3 h-3 text-pink-400 inline mr-1"></i>' : ''}
                            <span class="font-black ${w2 ? 'text-white' : 'text-slate-500'}">${format(v2)}</span>
                        </div>
                    </div>`;
            };

            // Score distribution bars for last 14 days
            const dist = (f) => {
                const buckets = { 'Elite (‚â•9)': 0, 'Great (8+)': 0, 'Good (7+)': 0, 'OK (6.5+)': 0, 'Poor (<6.5)': 0 };
                f.scores.slice(0, 14).forEach(s => {
                    if (s.score >= 9) buckets['Elite (‚â•9)']++;
                    else if (s.score >= 8) buckets['Great (8+)']++;
                    else if (s.score >= 7) buckets['Good (7+)']++;
                    else if (s.score >= 6.5) buckets['OK (6.5+)']++;
                    else buckets['Poor (<6.5)']++;
                });
                return buckets;
            };

            const d1 = dist(f1), d2 = dist(f2);
            const total = 14;
            const distColors = { 'Elite (‚â•9)': '#a855f7', 'Great (8+)': '#3b82f6', 'Good (7+)': '#22c55e', 'OK (6.5+)': '#eab308', 'Poor (<6.5)': '#ef4444' };

            const distBars = (d) => Object.entries(d).map(([label, count]) => {
                const pct = Math.round((count / total) * 100);
                return `
                    <div class="mb-1.5">
                        <div class="flex justify-between text-[10px] text-slate-500 mb-1 font-bold"><span>${label}</span><span>${count} game${count !== 1 ? 's' : ''}</span></div>
                        <div class="stat-bar-track"><div class="stat-bar-fill" style="width:${pct}%;background:${distColors[label]}"></div></div>
                    </div>`;
            }).join('');

            // Rolling history: last 5 rolling averages (labeled as actual dates)
            const rollingLabels = f1.scores.slice(0, 5).map(s => s.date.slice(5)).reverse();

            content.innerHTML = `
                <!-- Header Cards -->
                <div class="grid grid-cols-2 gap-6 mb-8">
                    <div class="glass-card p-6 rounded-2xl border-t-4 border-indigo-500">
                        <h3 class="text-2xl font-black text-white mb-1 flex items-center gap-2">${f1.name} ${f1.isKing ? '<i data-lucide="crown" class="w-5 h-5 text-amber-400 fill-amber-400"></i>' : ''}</h3>
                        <p class="text-indigo-400 font-bold text-xs uppercase mb-1">${f1.grade.label}</p>
                        <p class="text-3xl font-black ${getTailwindColor(f1.currentAvg)}">${f1.currentAvg}</p>
                        <p class="text-[10px] text-slate-500 uppercase font-bold">14-day avg</p>
                    </div>
                    <div class="glass-card p-6 rounded-2xl border-t-4 border-pink-500">
                        <h3 class="text-2xl font-black text-white mb-1 flex items-center gap-2">${f2.name} ${f2.isKing ? '<i data-lucide="crown" class="w-5 h-5 text-amber-400 fill-amber-400"></i>' : ''}</h3>
                        <p class="text-pink-400 font-bold text-xs uppercase mb-1">${f2.grade.label}</p>
                        <p class="text-3xl font-black ${getTailwindColor(f2.currentAvg)}">${f2.currentAvg}</p>
                        <p class="text-[10px] text-slate-500 uppercase font-bold">14-day avg</p>
                    </div>
                </div>

                <!-- Stat comparison table -->
                <div class="glass-card p-6 rounded-2xl mb-8">
                    <h4 class="text-xs font-black uppercase tracking-widest text-slate-400 mb-4 text-center">Head-to-Head Stats</h4>
                    ${statRow('Best (14d)', f1.stats.best14, f2.stats.best14, true, v => v.toFixed(1))}
                    ${statRow('Worst (14d)', f1.stats.worst14, f2.stats.worst14, true, v => v.toFixed(1))}
                    ${statRow('Profit Rate', f1.stats.profitRate, f2.stats.profitRate, true, v => v + '%')}
                    ${statRow('Form Points', f1.formPoints, f2.formPoints, true, v => (v > 0 ? '+' : '') + v)}
                    ${statRow('‚≠ê Stars', f1.stats.starCount, f2.stats.starCount, true)}
                    ${statRow('Valuation', f1.price, f2.price, false, v => v + ' CP')}
                </div>

                <!-- Charts + Distribution -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="glass-card p-6 rounded-2xl md:col-span-1"><h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Attribute DNA</h4><canvas id="compareRadarChart"></canvas></div>
                    <div class="glass-card p-6 rounded-2xl md:col-span-2"><h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Rolling 14d Average Momentum</h4><canvas id="compareLineChart" height="120"></canvas></div>
                </div>

                <!-- Score distribution -->
                <div class="grid grid-cols-2 gap-6">
                    <div class="glass-card p-6 rounded-2xl">
                        <h4 class="text-xs font-black uppercase tracking-widest text-indigo-400 mb-4">${f1.name} ‚Äî Score Distribution (14d)</h4>
                        ${distBars(d1)}
                    </div>
                    <div class="glass-card p-6 rounded-2xl">
                        <h4 class="text-xs font-black uppercase tracking-widest text-pink-400 mb-4">${f2.name} ‚Äî Score Distribution (14d)</h4>
                        ${distBars(d2)}
                    </div>
                </div>
            `;
            lucide.createIcons();

            // Radar
            new Chart(document.getElementById('compareRadarChart'), {
                type: 'radar',
                data: {
                    labels: ['Creativity', 'Consistency', 'Attendance', 'Presence', 'Quality'],
                    datasets: [
                        { label: f1.name, data: Object.values(f1.attributes), borderColor: '#6366f1', backgroundColor: 'rgba(99, 102, 241, 0.15)', pointBackgroundColor: '#6366f1', borderWidth: 2 },
                        { label: f2.name, data: Object.values(f2.attributes), borderColor: '#ec4899', backgroundColor: 'rgba(236, 72, 153, 0.15)', pointBackgroundColor: '#ec4899', borderWidth: 2 }
                    ]
                },
                options: {
                    scales: { r: { min: 0, max: 100, ticks: { display: false }, grid: { color: 'rgba(255,255,255,0.05)' }, pointLabels: { color: '#64748b', font: { weight: 'bold', size: 10 } } } },
                    plugins: { legend: { labels: { color: '#fff', font: { weight: 'bold' } } } }
                }
            });

            // Line: Rolling averages, actual dates as labels
            const r1 = f1.stats.rollingHistory.slice().reverse();
            const r2 = f2.stats.rollingHistory.slice().reverse();
            new Chart(document.getElementById('compareLineChart'), {
                type: 'line',
                data: {
                    labels: rollingLabels,
                    datasets: [
                        { label: f1.name, data: r1, borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.08)', tension: 0.4, fill: true, pointRadius: 5, pointBackgroundColor: '#6366f1' },
                        { label: f2.name, data: r2, borderColor: '#ec4899', backgroundColor: 'rgba(236,72,153,0.08)', tension: 0.4, fill: true, pointRadius: 5, pointBackgroundColor: '#ec4899' }
                    ]
                },
                options: {
                    scales: {
                        y: { min: 5, max: 10, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b', font: { weight: 'bold' } } },
                        x: { grid: { display: false }, ticks: { color: '#64748b', font: { weight: 'bold', size: 10 } } }
                    },
                    plugins: {
                        legend: { labels: { color: '#fff', font: { weight: 'bold' } } },
                        tooltip: {
                            callbacks: {
                                label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}`
                            }
                        }
                    }
                }
            });
        }

        // --- CHARTING & HELPERS ---
        function getTrendIcon(trend) { if (trend === 'up') return '<i data-lucide="trending-up" class="w-4 h-4 text-emerald-400"></i>'; if (trend === 'down') return '<i data-lucide="trending-down" class="w-4 h-4 text-red-400"></i>'; return '<i data-lucide="minus" class="w-4 h-4 text-slate-500"></i>'; }
        function initCharts(f) {
            new Chart(document.getElementById('attributeChart'), { type: 'radar', data: { labels: ['Creativity', 'Consistency', 'Attendance', 'Presence', 'Quality'], datasets: [{ data: Object.values(f.attributes), backgroundColor: 'rgba(99, 102, 241, 0.2)', borderColor: '#6366f1', borderWidth: 3, pointBackgroundColor: '#6366f1' }] }, options: { scales: { r: { min: 0, max: 100, ticks: { display: false }, grid: { color: 'rgba(255,255,255,0.05)' }, pointLabels: { color: '#64748b', font: { weight: 'bold', size: 10 } } } }, plugins: { legend: { display: false } } } });
            const histData = [...f.scores].reverse().slice(-10);
            new Chart(document.getElementById('historyChart'), { type: 'bar', data: { labels: histData.map(s => s.date.slice(5)), datasets: [{ data: histData.map(s => s.score), backgroundColor: histData.map(s => getHexColor(s.score)), borderRadius: 8 }] }, options: { plugins: { legend: { display: false } }, scales: { y: { min: 0, max: 10, grid: { color: 'rgba(255,255,255,0.05)' } } } } });
        }

        // ==============================
        // TUTORIAL
        // ==============================
        const TOTAL_TUT_STEPS = 8;
        let currentTutStep = 0;

        function buildTutDots() {
            const el = document.getElementById('tutDots');
            el.innerHTML = '';
            for (let i = 0; i < TOTAL_TUT_STEPS; i++) {
                const d = document.createElement('div');
                d.className = `tutorial-dot${i === currentTutStep ? ' active' : ''}`;
                el.appendChild(d);
            }
        }

        function updateTutUI() {
            for (let i = 0; i < TOTAL_TUT_STEPS; i++) {
                const s = document.getElementById(`tutStep${i}`);
                if (s) s.classList.toggle('active', i === currentTutStep);
            }
            buildTutDots();
            const prevBtn = document.getElementById('tutPrevBtn');
            const nextBtn = document.getElementById('tutNextBtn');
            if (prevBtn) prevBtn.classList.toggle('hidden', currentTutStep === 0);
            if (nextBtn) nextBtn.innerText = currentTutStep === TOTAL_TUT_STEPS - 1 ? '‚úì Got it!' : 'Next ‚Üí';
        }

        function tutNext() {
            if (currentTutStep < TOTAL_TUT_STEPS - 1) {
                currentTutStep++;
                updateTutUI();
            } else {
                closeTutorial();
            }
        }

        function tutPrev() {
            if (currentTutStep > 0) { currentTutStep--; updateTutUI(); }
        }

        function openTutorial() {
            currentTutStep = 0;
            document.getElementById('tutorialOverlay').classList.remove('hidden');
            updateTutUI();
        }

        function closeTutorial() {
            document.getElementById('tutorialOverlay').classList.add('hidden');
            localStorage.setItem('cr_tutorial_done', '1');
        }

        // ==============================
        // ACCOUNT & GLOBAL LEADERBOARD (Anthropic API powered)
        // ==============================
        let accountUser = null;

        function loadAccountUser() {
            const saved = localStorage.getItem('cr_account');
            if (saved) {
                accountUser = JSON.parse(saved);
                startAutoSync(); // begin hourly background sync
            }
        }

        function saveAccountUser(u) {
            accountUser = u;
            localStorage.setItem('cr_account', JSON.stringify(u));
        }

        function openAccountModal() {
            document.getElementById('accountModal').classList.remove('hidden');
            lucide.createIcons();
            renderAccountPanel();
            loadGlobalLeaderboard();
        }

        function closeAccountModal() {
            document.getElementById('accountModal').classList.add('hidden');
        }

        function renderAccountPanel() {
            const panel = document.getElementById('accountPanel');
            if (accountUser) {
                const nw = parseFloat(document.getElementById('netWorth').innerText) || 0;
                const lastSync = accountUser.lastSync
                    ? new Date(accountUser.lastSync).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    : 'Never';
                panel.innerHTML = `
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                        <div>
                            <div class="text-[10px] uppercase font-black tracking-widest text-slate-400 mb-1">Signed in as</div>
                            <div class="text-xl font-black text-white flex items-center gap-2">
                                <span class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-sm font-black">${accountUser.username[0].toUpperCase()}</span>
                                ${accountUser.username}
                            </div>
                            <div class="text-xs text-slate-500 mt-1">
                                Net worth: <span class="text-emerald-400 font-bold">${nw.toFixed(0)} CP</span>
                                <span class="mx-2 text-slate-700">¬∑</span>
                                <span id="lastSyncLabel">Last synced: ${lastSync}</span>
                                <span class="ml-2 text-[10px] text-indigo-400 font-bold">¬∑ Auto-syncs hourly</span>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="publishToLeaderboard()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 text-xs font-black uppercase tracking-wider rounded-xl transition flex items-center gap-2" title="Sync now">
                                <i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i> Sync Now
                            </button>
                            <button onclick="signOut()" class="px-4 py-2 bg-slate-800 hover:bg-red-500/20 hover:text-red-400 text-slate-400 text-xs font-black uppercase tracking-wider rounded-xl transition">Sign Out</button>
                        </div>
                    </div>
                `;
            } else {
                panel.innerHTML = `
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-6">
                        <div>
                            <div class="text-sm font-bold text-white mb-1">Create a free account</div>
                            <div class="text-xs text-slate-400">Appear on the global leaderboard. Your score syncs automatically every hour.</div>
                        </div>
                        <div class="flex gap-2 w-full sm:w-auto">
                            <input type="text" id="usernameInput" placeholder="Pick a username..." maxlength="20" class="bg-slate-800 border border-slate-700 focus:border-indigo-500 outline-none text-white text-sm px-3 py-2 rounded-xl w-full sm:w-48 transition">
                            <button onclick="createAccount()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-black uppercase tracking-wider rounded-xl transition whitespace-nowrap flex items-center gap-2">
                                <i data-lucide="user-plus" class="w-3.5 h-3.5"></i> Join
                            </button>
                        </div>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        async function createAccount() {
            const input = document.getElementById('usernameInput');
            const username = input ? input.value.trim() : '';
            if (!username || username.length < 2) return showToast('Enter a username (min 2 chars)', 'error');
            const userId = 'user_' + username.toLowerCase().replace(/[^a-z0-9]/g, '') + '_' + Math.random().toString(36).slice(2, 6);
            saveAccountUser({ username, userId });
            startAutoSync();
            showToast(`Account created! Welcome, ${username}!`, 'gold');
            await publishToLeaderboard();
            renderAccountPanel();
        }

        function signOut() {
            accountUser = null;
            localStorage.removeItem('cr_account');
            renderAccountPanel();
        }

        // Paste your Google Apps Script Web App URL here after deploying
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzyhtAE6AuVTzfNmt9ehnLzr7CDxd4blKSBAXUJm3xCCujVUPfmGbhrV4_XnDjqZdktgw/exec';
        const AUTO_SYNC_INTERVAL_MS = 60 * 60 * 1000; // 1 hour
        let autoSyncInterval = null;

        // Silent background publish ‚Äî no toasts, no errors shown to user
        async function silentPublish() {
            if (!accountUser) return;
            if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_URL_HERE') return;
            const nw = parseFloat(document.getElementById('netWorth').innerText) || 0;
            const rosterNames = wallet.roster.map(id => {
                const f = processedFarmers.find(x => x.id === id);
                return f ? f.name : id;
            });
            try {
                const res = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        userId: accountUser.userId,
                        username: accountUser.username,
                        netWorth: nw,
                        roster: rosterNames
                    })
                });
                const json = await res.json();
                if (json.ok) {
                    accountUser.lastSync = Date.now();
                    localStorage.setItem('cr_account', JSON.stringify(accountUser));
                    // Refresh the "last synced" label if the modal is open
                    const syncLabel = document.getElementById('lastSyncLabel');
                    if (syncLabel) syncLabel.innerText = 'Last synced: just now';
                }
            } catch(e) {
                // Fail silently ‚Äî background sync, user doesn't need to know
            }
        }

        // Start the hourly background auto-sync
        function startAutoSync() {
            if (autoSyncInterval) clearInterval(autoSyncInterval);
            autoSyncInterval = setInterval(() => {
                silentPublish();
            }, AUTO_SYNC_INTERVAL_MS);
        }

        async function publishToLeaderboard() {
            if (!accountUser) return showToast('Create an account first', 'error');
            if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_URL_HERE') {
                return showToast('Paste your Apps Script URL into index.html first!', 'error');
            }
            const nw = parseFloat(document.getElementById('netWorth').innerText) || 0;
            const rosterNames = wallet.roster.map(id => {
                const f = processedFarmers.find(x => x.id === id);
                return f ? f.name : id;
            });
            try {
                const res = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        userId: accountUser.userId,
                        username: accountUser.username,
                        netWorth: nw,
                        roster: rosterNames
                    })
                });
                const json = await res.json();
                if (!json.ok) throw new Error(json.error || 'Unknown error');
                accountUser.lastSync = Date.now();
                localStorage.setItem('cr_account', JSON.stringify(accountUser));
                showToast('Leaderboard updated! üèÜ', 'success');
                renderAccountPanel();
                loadGlobalLeaderboard();
            } catch (e) {
                console.error('Publish error:', e);
                showToast('Could not publish. Check your Apps Script URL.', 'error');
            }
        }

        async function loadGlobalLeaderboard() {
            const listEl = document.getElementById('globalLbList');
            listEl.innerHTML = `<div class="p-8 text-center"><div class="loading-spinner mx-auto mb-3"></div><p class="text-slate-500 text-sm font-bold animate-pulse">FETCHING MANAGERS...</p></div>`;

            if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_URL_HERE') {
                listEl.innerHTML = `<div class="p-8 text-center text-slate-500 font-bold text-sm">‚öôÔ∏è Paste your Apps Script URL into index.html to enable the leaderboard.</div>`;
                return;
            }

            try {
                const res = await fetch(APPS_SCRIPT_URL);
                const json = await res.json();
                if (!json.ok) throw new Error('Bad response');

                const entries = (json.entries || []).sort((a, b) => b.netWorth - a.netWorth);

                document.getElementById('lbLastUpdated').innerText = `${entries.length} manager${entries.length !== 1 ? 's' : ''} registered`;

                if (entries.length === 0) {
                    listEl.innerHTML = `<div class="p-8 text-center text-slate-500 font-bold text-sm">No managers yet. Be the first to publish your score!</div>`;
                    return;
                }

                listEl.innerHTML = entries.map((e, i) => {
                    const isMe = accountUser && e.username === accountUser.username;
                    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `#${i + 1}`;
                    const rowClass = i === 0 ? 'lb-gold' : i === 1 ? 'lb-silver' : i === 2 ? 'lb-bronze' : '';
                    const rosterHtml = e.roster && e.roster.length > 0
                        ? e.roster.map(name => `<span class="px-2 py-0.5 bg-slate-800 text-slate-300 rounded-md text-[10px] font-bold border border-slate-700">${name}</span>`).join('')
                        : '<span class="text-slate-600 text-[10px]">No roster</span>';
                    return `
                        <div class="lb-row p-4 flex flex-col sm:flex-row sm:items-center gap-3 ${rowClass} ${isMe ? 'bg-indigo-600/10' : ''}">
                            <div class="w-10 text-center font-black text-lg ${i === 0 ? 'text-amber-400' : i === 1 ? 'text-slate-300' : i === 2 ? 'text-amber-600' : 'text-slate-600'}">${medal}</div>
                            <div class="flex-1 min-w-0">
                                <div class="font-black text-white flex items-center gap-2">
                                    ${e.username}
                                    ${isMe ? '<span class="text-[9px] bg-indigo-600 text-white px-1.5 py-0.5 rounded font-black uppercase tracking-wider">You</span>' : ''}
                                </div>
                                <div class="flex flex-wrap gap-1 mt-1">${rosterHtml}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-black text-emerald-400">${e.netWorth.toFixed(0)}</div>
                                <div class="text-[10px] text-slate-500 font-bold uppercase">CP Net Worth</div>
                            </div>
                        </div>`;
                }).join('');
                lucide.createIcons();
            } catch(e) {
                console.error('Leaderboard load error:', e);
                listEl.innerHTML = `<div class="p-8 text-center text-slate-500 font-bold text-sm">Failed to load leaderboard. Check your Apps Script URL.</div>`;
            }
        }

        window.onload = init;
    </script>
</body>
</html>
