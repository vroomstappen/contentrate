<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ContentRate - The Content Farmer Leaderboard (Client-Side)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/c60012891f.js" crossorigin="anonymous"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .score-red { background-color: #ef4444; }
        .score-orange { background-color: #f97316; }
        .score-yellow { background-color: #facc15; }
        .score-green { background-color: #10b981; } /* FIX: Changed from blueish #22c5e5 to a clear green */
        .score-lightblue { background-color: #0ea5e9; }
        .score-purple { background-color: #8b5cf6; }

        /* Styles for the new Timeline Chart */
        .timeline-chart-container { 
            height: 150px; 
            position: relative; 
            padding-top: 20px; 
            padding-bottom: 20px;
        }
        .avg-line {
            position: absolute;
            height: 3px;
            background-color: #eab308; /* Yellow 500 */
            top: 50%;
            left: 0;
            right: 0;
            transform: translateY(-50%);
            z-index: 10;
        }
        .avg-label {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translate(-100%, -50%);
            font-size: 0.75rem;
            font-weight: bold;
            color: #fcd34d; /* Yellow 300 */
            padding-right: 8px;
        }
        .score-point {
            position: absolute;
            width: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s ease;
            z-index: 20; /* Above the line */
        }
        .score-value-box {
            font-weight: bold;
            font-size: 0.875rem; /* text-sm */
            padding: 4px 8px;
            border-radius: 6px;
            color: #1f2937; /* Gray 800 */
            margin-bottom: 4px; /* Space between score and date */
        }
        .score-date-label {
            font-size: 0.75rem; /* text-xs */
            color: #9ca3af; /* Gray 400 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">

    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">

        <header class="text-center mb-8 border-b border-gray-700 pb-4">
            <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-red-600 mb-2">
                ContentRate
            </h1>
            <p class="text-gray-400 text-lg mb-2">Ranking the Content Output of the Greatest Farmers. (Client-Side Data)</p>
            <p id="user-info" class="text-xs text-gray-500">Data Source: Browser LocalStorage</p>
        </header>

        <div id="main-content" class="bg-gray-800 rounded-xl shadow-2xl p-4 sm:p-6">
            <p id="loading-status" class="text-center text-gray-400">Loading data from LocalStorage...</p>
        </div>

        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p>ContentRate | All data is stored in your browser.</p>
            <button onclick="showAdminModal()" id="admin-toggle-button" class="mt-1 text-yellow-500 hover:text-yellow-400 transition duration-150">
                Admin Access
            </button>
            <div id="admin-error" class="text-red-500 mt-2 hidden"></div>
        </footer>
    </div>

    <div id="admin-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm shadow-2xl border border-yellow-600">
            <h3 class="text-2xl font-bold mb-4 text-yellow-400">Enter Admin Code</h3>
            <input type="password" id="admin-code-input" class="w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition" placeholder="Code (4463)">
            <div id="code-error" class="text-red-500 text-sm mt-2 hidden">Invalid Code.</div>
            <div class="flex justify-between mt-4">
                <button onclick="closeAdminModal()" class="py-2 px-4 bg-gray-600 rounded-lg text-white hover:bg-gray-500 transition">Cancel</button>
                <button onclick="checkAdminCode()" class="py-2 px-4 bg-yellow-600 rounded-lg text-gray-900 font-semibold hover:bg-yellow-500 transition">Submit</button>
            </div>
        </div>
    </div>

    <div id="message-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-xs shadow-2xl border border-blue-600">
            <h3 id="message-title" class="text-xl font-bold mb-3 text-blue-400">Success</h3>
            <p id="message-body" class="text-gray-300">Operation successful.</p>
            <div class="text-right mt-4">
                <button onclick="closeMessageModal()" class="py-2 px-4 bg-blue-600 rounded-lg text-white font-semibold hover:bg-blue-500 transition">OK</button>
            </div>
        </div>
    </div>


    <script>
        // --- GLOBAL APP STATE ---
        const LOCAL_STORAGE_KEY = 'contentRateFarmersData';
        const ADMIN_CODE = '4463';
        let farmersData = []; // Will be populated by LocalStorage
        
        let currentView = 'leaderboard'; // 'leaderboard', 'profile', 'admin'
        let selectedFarmerId = null;
        let searchTerm = '';
        let isAdminLoggedIn = false;


        // --- LOCAL STORAGE & DATA INITIALIZATION ---

        /**
         * Loads data from localStorage.
         * @returns {Array<Object>}
         */
        function loadDataFromLocalStorage() {
            try {
                const json = localStorage.getItem(LOCAL_STORAGE_KEY);
                return json ? JSON.parse(json) : [];
            } catch (e) {
                console.error("Error loading data from localStorage:", e);
                return [];
            }
        }

        /**
         * Saves the current farmersData array to localStorage.
         */
        function saveDataToLocalStorage() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(farmersData));
                console.log("Data saved to localStorage.");
            } catch (e) {
                console.error("Error saving data to localStorage:", e);
                showMessage('Save Error', 'Failed to save data to your browser storage. Check console.');
            }
        }

        /**
         * Generates a simple, unique ID (UUID-like).
         * @returns {string}
         */
        function generateUniqueId() {
            return 'id-' + Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
        }
        
        /**
         * Initializes data, ensuring scores are sorted upon load for consistent 5-day average calculation.
         */
        function initializeData() {
            farmersData = loadDataFromLocalStorage();
            
            // Re-sort scores descending by date on load for consistency
            farmersData.forEach(farmer => {
                farmer.scores = (farmer.scores || []).sort((a, b) => new Date(b.date) - new Date(a.date));
            });

            // Update the view once data is ready
            document.getElementById('loading-status').textContent = 'Data loaded. Rendering leaderboard...';
            updateView();
        }

        // --- CORE LOGIC FUNCTIONS ---

        /**
         * Determines the color class and rating name based on a score.
         * @param {number} score
         * @returns {{colorClass: string, ratingName: string}}
         */
        function getScoreDetails(score) {
            score = parseFloat(score);
            if (score >= 9.0) return { colorClass: 'score-purple', ratingName: 'Absolute Cinema' };
            if (score >= 8.0) return { colorClass: 'score-lightblue', ratingName: 'Great Content Farm' };
            if (score >= 7.0) return { colorClass: 'score-green', ratingName: 'Good Content Farm' };
            if (score >= 6.5) return { colorClass: 'score-yellow', ratingName: 'Average Content' };
            if (score >= 6.0) return { colorClass: 'score-orange', ratingName: 'Below Average' };
            return { colorClass: 'score-red', ratingName: 'Absolute Disasterclass' };
        }

        /**
         * Calculates the 5-day average score for a farmer.
         * Scores are assumed to be sorted descending by date.
         * @param {Object} farmer
         * @returns {number} The 5-day average, or 0 if no scores.
         */
        function calculate5DayAverage(farmer) {
            // Scores are assumed to be sorted descending by date from the initializeData function
            const last5Scores = (farmer.scores || []).slice(0, 5).map(s => s.score);
            if (last5Scores.length === 0) return 0;
            const sum = last5Scores.reduce((acc, score) => acc + score, 0);
            return sum / last5Scores.length;
        }

        /**
         * Calculates the percentile of a farmer's current average score among all farmers.
         * @param {number} farmerAverage
         * @param {Array<number>} allAverages
         * @returns {number} Percentile (0-100)
         */
        function calculatePercentile(farmerAverage, allAverages) {
            if (allAverages.length === 0) return 0;
            // Filter out 0 averages to ensure meaningful percentile for active farmers
            const activeAverages = allAverages.filter(a => a > 0);
            if (activeAverages.length === 0) return 0;

            const sortedAverages = [...activeAverages].sort((a, b) => a - b);
            const lowerCount = sortedAverages.filter(avg => avg < farmerAverage).length;
            const equalCount = sortedAverages.filter(avg => avg === farmerAverage).length;
            return Math.round(((lowerCount + 0.5 * equalCount) / activeAverages.length) * 100);
        }

        // --- VIEW RENDERING FUNCTIONS ---

        /**
         * Renders the awards headline banner.
         * @param {Array<Object>} rankedFarmers
         * @returns {string} HTML string
         */
        function renderAwardsHeadline(rankedFarmers) {
            // Note: rankedFarmers already has averages calculated
            const fotd = rankedFarmers.find(f => f.farmerOfTheDay);
            const fotm = rankedFarmers.find(f => f.farmerOfTheMonth);

            const fotdHtml = fotd
                ? `<div class="p-3 bg-red-800 rounded-lg shadow-md flex items-center mb-2">
                    <i class="fas fa-crown text-2xl text-red-400 mr-3"></i>
                    <span class="font-semibold">Content Farmer of the Day:</span>
                    <span class="ml-2 text-white font-bold">${fotd.name} (${fotd.average.toFixed(2)})</span>
                </div>`
                : '';

            const fotmHtml = fotm
                ? `<div class="p-3 bg-purple-800 rounded-lg shadow-md flex items-center">
                    <i class="fas fa-trophy text-2xl text-purple-400 mr-3"></i>
                    <span class="font-semibold">Content Farmer of the Month:</span>
                    <span class="ml-2 text-white font-bold">${fotm.name} (${fotm.average.toFixed(2)})</span>
                </div>`
                : '';

            if (fotdHtml || fotmHtml) {
                return `<div class="mb-6 space-y-2">${fotdHtml}${fotmHtml}</div>`;
            }
            return '';
        }

        /**
         * Renders the main leaderboard view.
         */
        function renderLeaderboard() {
            const container = document.getElementById('main-content');
            
            // Show loading status if data hasn't been fetched yet
            if (farmersData.length === 0 && document.getElementById('loading-status')) {
                 container.innerHTML = `<p id="loading-status" class="text-center text-gray-400 p-8">Loading leaderboard data...</p>`;
                 return;
            }
            
            const allAverages = farmersData.map(calculate5DayAverage);

            // 1. Calculate averages and sort the farmers
            const rankedFarmers = farmersData.map(farmer => ({
                ...farmer,
                average: calculate5DayAverage(farmer),
                rank: 0 // Placeholder
            })).sort((a, b) => b.average - a.average);

            // 2. Apply search filter
            const filteredFarmers = rankedFarmers.filter(f =>
                f.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            // 3. Determine and assign ranks (handles ties correctly)
            let currentRank = 1;
            for (let i = 0; i < rankedFarmers.length; i++) {
                if (i > 0 && rankedFarmers[i].average < rankedFarmers[i - 1].average) {
                    currentRank = i + 1;
                }
                rankedFarmers[i].rank = currentRank;
            }

            // --- HTML Markup Generation ---
            let farmerListHtml = '';
            if (filteredFarmers.length === 0 && farmersData.length > 0) {
                farmerListHtml = `
                    <p class="text-gray-400 p-8 text-center text-lg">
                        No content farmers found matching "${searchTerm}".
                    </p>
                `;
            } else if (farmersData.length === 0) {
                 farmerListHtml = `
                    <p class="text-gray-400 p-8 text-center text-lg">
                        The Leaderboard is currently empty. Use the Admin Panel to add your first content farmer!
                    </p>
                `;
            } else {
                farmerListHtml = filteredFarmers.map(farmer => {
                    const scoreDetails = getScoreDetails(farmer.average);
                    const percentile = calculatePercentile(farmer.average, allAverages);

                    return `
                        <div class="flex items-center p-3 sm:p-4 mb-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition duration-150 cursor-pointer" onclick="showProfile('${farmer.id}')">
                            <div class="text-xl font-bold w-12 text-center text-yellow-400">${farmer.rank}</div>
                            <div class="flex-grow min-w-0">
                                <span class="text-lg font-semibold truncate block">${farmer.name}</span>
                                <span class="text-sm text-gray-400">Top ${100 - percentile}% Content Farmer</span>
                            </div>
                            <div class="flex items-center space-x-2 mx-4">
                                ${farmer.farmerOfTheDay ? '<span title="Content Farmer of the Day" class="text-xl text-red-500"><i class="fas fa-crown"></i></span>' : ''}
                                ${farmer.farmerOfTheMonth ? '<span title="Content Farmer of the Month" class="text-xl text-purple-500"><i class="fas fa-trophy"></i></span>' : ''}
                            </div>
                            <div class="w-16 text-center">
                                <span class="block text-2xl font-extrabold p-1 rounded-full text-gray-900 ${scoreDetails.colorClass}">
                                    ${farmer.average.toFixed(2)}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');
            }


            // --- Main Leaderboard Layout ---
            container.innerHTML = `
                <h2 class="text-3xl font-bold mb-6 text-white border-b border-gray-700 pb-3">Leaderboard</h2>

                ${renderAwardsHeadline(rankedFarmers)}

                <div class="mb-4">
                    <input type="text" id="search-bar" oninput="handleSearch(this.value)"
                        class="w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition"
                        placeholder="Search for a Content Farmer..." value="${searchTerm}">
                </div>

                <div class="flex items-center p-3 mb-2 text-gray-400 font-semibold border-b border-gray-600">
                    <div class="w-12 text-center">Rank</div>
                    <div class="flex-grow">Farmer</div>
                    <div class="mx-4 w-10">Awards</div>
                    <div class="w-16 text-center">Avg (5D)</div>
                </div>

                <div>
                    ${farmerListHtml}
                </div>
            `;
        }

        /**
         * Renders the detailed profile view for a selected farmer.
         * @param {string} farmerId
         */
        function renderProfile(farmerId) {
            const container = document.getElementById('main-content');
            const farmer = farmersData.find(f => f.id === farmerId);
            if (!farmer) {
                // Redirect to leaderboard if farmer not found
                showLeaderboard();
                return;
            }

            const allAverages = farmersData.map(calculate5DayAverage);
            const currentAverage = calculate5DayAverage(farmer);
            const scoreDetails = getScoreDetails(currentAverage);
            const percentile = calculatePercentile(currentAverage, allAverages);

            // --- Timeline Chart Data Preparation (Last 5 days) ---
            // Use scores that are guaranteed to be sorted descending by date
            const last5 = (farmer.scores || []).slice(0, 5).reverse(); // Reverse for chronological display
            const MIN_SCORE_SCALE = 3.0;
            const MAX_SCORE_SCALE = 10.0;
            const CHART_RANGE = MAX_SCORE_SCALE - MIN_SCORE_SCALE;
            
            const chartSpaceMin = 15; // 15% from top
            const chartSpaceMax = 85; // 85% from top
            const chartSpaceRange = chartSpaceMax - chartSpaceMin; // 70%

            const scoreMarkers = last5.map((s, index) => {
                const score = s.score;
                const barColor = getScoreDetails(score).colorClass;

                const scoreRangeNormalized = (score - MIN_SCORE_SCALE) / CHART_RANGE; // 0 to 1

                // Top percentage: chartSpaceMax - (normalized * chartSpaceRange)
                const finalTopPercent = chartSpaceMax - (scoreRangeNormalized * chartSpaceRange);


                // Calculate horizontal position (left property)
                const horizontalStep = 100 / (last5.length + 1);
                const calculatedLeftPercent = (index + 1) * horizontalStep;

                return `
                    <div class="score-point absolute" style="left: ${calculatedLeftPercent}%; top: ${finalTopPercent}%; transform: translate(-50%, -50%);">
                        <div class="score-value-box ${barColor}">${score.toFixed(1)}</div>
                        <span class="score-date-label">${s.date.slice(5)}</span>
                    </div>
                `;
            }).join('');

            // --- All Scores List ---
            const allScoresList = (farmer.scores || []).map(s => {
                const details = getScoreDetails(s.score);
                return `
                    <li class="flex justify-between items-center py-2 border-b border-gray-700 last:border-b-0">
                        <span class="text-gray-400">${s.date}</span>
                        <div class="flex items-center space-x-3">
                            <span class="font-medium text-gray-300">${details.ratingName}</span>
                            <span class="px-2 py-1 text-sm font-bold rounded-md text-gray-900 ${details.colorClass}">${s.score.toFixed(1)}</span>
                        </div>
                    </li>
                `;
            }).join('');

            // --- HTML Markup Generation ---
            container.innerHTML = `
                <button onclick="showLeaderboard()" class="text-yellow-500 hover:text-yellow-400 mb-4 transition duration-150">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Leaderboard
                </button>

                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between border-b border-gray-700 pb-4 mb-6">
                    <div>
                        <h2 class="text-4xl font-extrabold text-white">${farmer.name}</h2>
                        <p class="text-gray-400 mt-1 text-xl">Current 5-Day Avg:
                            <span class="font-bold text-gray-900 px-2 rounded-full ${scoreDetails.colorClass}">
                                ${currentAverage.toFixed(2)}
                            </span>
                        </p>
                    </div>
                    <div class="mt-4 sm:mt-0 text-right">
                        <p class="text-lg font-bold text-yellow-400">Percentile:</p>
                        <p class="text-3xl font-extrabold text-white">${percentile}%</p>
                        <p class="text-sm text-gray-400">Better than ${percentile}% of all active farmers</p>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-2xl font-bold mb-4 text-white">Last 5 Days Content Scores</h3>
                    <div class="timeline-chart-container relative p-4 bg-gray-700 rounded-xl">
                        <div class="avg-line">
                            <span class="avg-label">6.5 Avg</span>
                        </div>
                        
                        <div class="relative h-full">
                            ${scoreMarkers}
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 text-center">Score range: 3.0 (bottom) to 10.0 (top)</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-700 p-4 rounded-lg shadow-inner">
                        <h3 class="text-xl font-bold mb-3 text-red-400"><i class="fas fa-medal mr-2"></i> Accolades</h3>
                        <ul class="space-y-2">
                            ${farmer.accolades && farmer.accolades.length > 0 ? farmer.accolades.map(a => `<li class="text-gray-300 flex items-center"><i class="fas fa-star text-yellow-500 mr-2 text-sm"></i>${a}</li>`).join('') : '<li class="text-gray-500">No accolades yet.</li>'}
                        </ul>
                    </div>

                    <div class="bg-gray-700 p-4 rounded-lg shadow-inner max-h-96 overflow-y-auto">
                        <h3 class="text-xl font-bold mb-3 text-blue-400"><i class="fas fa-history mr-2"></i> All Recorded Scores</h3>
                        <ul>
                            ${allScoresList.length > 0 ? allScoresList : '<li class="text-gray-500 py-2">No scores recorded.</li>'}
                        </ul>
                    </div>
                </div>
            `;
        }

        /**
         * Renders the Admin Panel view.
         */
        function renderAdminPanel() {
            const container = document.getElementById('main-content');

            if (!isAdminLoggedIn) {
                 container.innerHTML = `<p class="text-red-400 p-8 text-center text-xl">Access Denied. Please log in via the button below.</p>`;
                 return;
            }

            // Options for adding scores
            const farmerOptions = farmersData.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
            const today = new Date().toISOString().split('T')[0];

            container.innerHTML = `
                <h2 class="text-3xl font-bold mb-6 text-yellow-400 border-b border-gray-700 pb-3">Admin Panel (SECRET CODE: ${ADMIN_CODE})</h2>

                <button onclick="showLeaderboard()" class="text-yellow-500 hover:text-yellow-400 mb-6 transition duration-150">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Leaderboard
                </button>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

                    <div class="bg-gray-700 p-6 rounded-xl">
                        <h3 class="text-2xl font-semibold mb-4 text-green-400">Add New Content Farmer</h3>
                        <form id="add-farmer-form" onsubmit="event.preventDefault(); addNewFarmer();">
                            <label for="new-farmer-name" class="block text-gray-300 mb-2">Farmer Name</label>
                            <input type="text" id="new-farmer-name" required class="w-full p-3 mb-4 rounded-lg bg-gray-800 text-white focus:ring-2 focus:ring-green-500 transition">

                            <button type="submit" class="w-full py-3 bg-green-600 rounded-lg text-white font-semibold hover:bg-green-500 transition">
                                Add Farmer
                            </button>
                            <p id="add-farmer-status" class="mt-3 text-sm hidden"></p>
                        </form>
                    </div>

                    <div class="bg-gray-700 p-6 rounded-xl">
                        <h3 class="text-2xl font-semibold mb-4 text-blue-400">Add/Update Daily Score</h3>
                        <form id="add-score-form" onsubmit="event.preventDefault(); addOrUpdateScore();">
                            <label for="score-farmer-id" class="block text-gray-300 mb-2">Select Farmer</label>
                            <select id="score-farmer-id" required class="w-full p-3 mb-4 rounded-lg bg-gray-800 text-white focus:ring-2 focus:ring-blue-500 transition">
                                <option value="">--- Select Farmer ---</option>
                                ${farmerOptions}
                            </select>

                            <label for="score-date" class="block text-gray-300 mb-2">Date</label>
                            <input type="date" id="score-date" value="${today}" required class="w-full p-3 mb-4 rounded-lg bg-gray-800 text-white focus:ring-2 focus:ring-blue-500 transition">

                            <label for="score-value" class="block text-gray-300 mb-2">Score (3.0 - 10.0)</label>
                            <input type="number" id="score-value" min="3.0" max="10.0" step="0.1" required class="w-full p-3 mb-4 rounded-lg bg-gray-800 text-white focus:ring-2 focus:ring-blue-500 transition">

                            <button type="submit" class="w-full py-3 bg-blue-600 rounded-lg text-white font-semibold hover:bg-blue-500 transition">
                                Add/Update Score
                            </button>
                            <p id="add-score-status" class="mt-3 text-sm hidden"></p>
                        </form>
                    </div>

                    <div class="lg:col-span-2 bg-gray-700 p-6 rounded-xl">
                        <h3 class="text-2xl font-semibold mb-4 text-red-400">Manage Awards (Content Farmer of the Day/Month)</h3>
                        <p class="text-gray-400 mb-4">Click a farmer to assign or remove the 'Content Farmer of the Day' award. (Only one can hold the title.)</p>
                        <div class="flex flex-wrap gap-3">
                            ${farmersData.map(f => `
                                <button onclick="assignAward('${f.id}', 'fotd')" class="py-2 px-4 rounded-lg text-sm transition ${f.farmerOfTheDay ? 'bg-red-500 text-white font-bold' : 'bg-gray-600 text-gray-200 hover:bg-gray-500'}">
                                    FOTD: ${f.name}
                                </button>
                            `).join('')}
                        </div>
                        <p class="text-gray-400 mt-6 mb-4">Click a farmer to assign or remove the 'Content Farmer of the Month' award.</p>
                        <div class="flex flex-wrap gap-3">
                            ${farmersData.map(f => `
                                <button onclick="assignAward('${f.id}', 'fotm')" class="py-2 px-4 rounded-lg text-sm transition ${f.farmerOfTheMonth ? 'bg-purple-500 text-white font-bold' : 'bg-gray-600 text-gray-200 hover:bg-gray-500'}">
                                    FOTM: ${f.name}
                                </button>
                            `).join('')}
                        </div>
                        ${farmersData.length === 0 ? '<p class="text-gray-500 mt-4">Add farmers in section 1 to manage awards.</p>' : ''}
                    </div>
                </div>
            `;
        }
        
        // --- UI & State Control ---

        function updateView() {
            // Update the Admin button text based on login status
            const adminBtn = document.getElementById('admin-toggle-button');
            adminBtn.textContent = isAdminLoggedIn ? 'Admin Logout' : 'Admin Access';

            if (currentView === 'profile') {
                renderProfile(selectedFarmerId);
            } else if (currentView === 'admin') {
                renderAdminPanel();
            } else {
                renderLeaderboard();
            }
        }

        window.showLeaderboard = function() {
            currentView = 'leaderboard';
            selectedFarmerId = null;
            updateView();
        }

        window.showProfile = function(id) {
            currentView = 'profile';
            selectedFarmerId = id;
            updateView();
        }

        function showAdminView() {
            currentView = 'admin';
            updateView();
        }

        window.handleSearch = function(term) {
            searchTerm = term;
            renderLeaderboard();
        }

        // --- ADMIN MODAL & AUTHENTICATION ---

        window.showAdminModal = function() {
            if (isAdminLoggedIn) {
                handleAdminLogout();
                return;
            }
            document.getElementById('admin-modal').classList.remove('hidden');
        }

        window.closeAdminModal = function() {
            document.getElementById('admin-modal').classList.add('hidden');
            document.getElementById('admin-code-input').value = '';
            document.getElementById('code-error').classList.add('hidden');
        }

        window.checkAdminCode = function() {
            const code = document.getElementById('admin-code-input').value;
            if (code === ADMIN_CODE) {
                isAdminLoggedIn = true;
                closeAdminModal();
                showAdminView();
            } else {
                document.getElementById('code-error').classList.remove('hidden');
            }
        }
        
        function handleAdminLogout() {
            isAdminLoggedIn = false;
            showMessage('Admin Logged Out', 'You have successfully logged out of the Admin Panel.');
            showLeaderboard();
        }


        // --- ADMIN PANEL ACTIONS (Local Storage Integration) ---

        /**
         * Adds a new farmer object to the local farmersData array.
         */
        window.addNewFarmer = function() {
            const name = document.getElementById('new-farmer-name').value.trim();
            const statusEl = document.getElementById('add-farmer-status');
            statusEl.classList.add('hidden'); 

            if (!name) {
                statusEl.textContent = 'Name cannot be empty.';
                statusEl.classList.remove('hidden');
                statusEl.classList.add('text-red-400');
                return;
            }

            try {
                const newFarmer = {
                    id: generateUniqueId(), // Use local ID generation
                    name: name,
                    scores: [],
                    accolades: [],
                    farmerOfTheDay: false,
                    farmerOfTheMonth: false,
                    createdAt: new Date().toISOString()
                };
                
                farmersData.push(newFarmer);
                saveDataToLocalStorage();
                
                document.getElementById('add-farmer-form').reset();
                showMessage('Farmer Added', `Successfully added "${name}".`);
                updateView(); // Rerender to update the options in the Admin Panel
                

            } catch (e) {
                console.error("Error adding farmer: ", e);
                statusEl.textContent = 'Error adding farmer: ' + e.message;
                statusEl.classList.remove('hidden');
                statusEl.classList.add('text-red-400');
            }
        }

        /**
         * Adds or updates a score for an existing farmer in the local farmersData array.
         */
        window.addOrUpdateScore = function() {
            const farmerId = document.getElementById('score-farmer-id').value;
            const date = document.getElementById('score-date').value;
            const score = parseFloat(document.getElementById('score-value').value);
            const statusEl = document.getElementById('add-score-status');
            statusEl.classList.add('hidden'); 

            if (!farmerId || !date || isNaN(score) || score < 3.0 || score > 10.0) {
                statusEl.textContent = 'Please check all inputs. Score must be between 3.0 and 10.0.';
                statusEl.classList.remove('hidden');
                statusEl.classList.add('text-red-400');
                return;
            }

            const farmerIndex = farmersData.findIndex(f => f.id === farmerId);
            if (farmerIndex === -1) return;

            const farmer = farmersData[farmerIndex];
            const existingScores = farmer.scores || [];
            const existingScoreIndex = existingScores.findIndex(s => s.date === date);

            const newScore = { date, score: parseFloat(score.toFixed(1)) };
            let updatedScores;
            let message;

            if (existingScoreIndex !== -1) {
                // Update existing score
                updatedScores = existingScores.map((s, idx) => 
                    idx === existingScoreIndex ? newScore : s
                );
                message = `Updated ${farmer.name}'s score on ${date} to ${score.toFixed(1)}.`;
            } else {
                // Add new score
                updatedScores = [...existingScores, newScore];
                message = `Added a new score of ${score.toFixed(1)} for ${farmer.name} on ${date}.`;
            }

            // Sort scores descending by date
            updatedScores.sort((a, b) => new Date(b.date) - new Date(a.date));

            try {
                // Update the farmer object in the array
                farmersData[farmerIndex].scores = updatedScores;
                
                saveDataToLocalStorage();
                
                document.getElementById('add-score-form').reset();
                showMessage('Score Saved', message);
                updateView();

            } catch (e) {
                console.error("Error updating score: ", e);
                statusEl.textContent = 'Error saving score to local storage: ' + e.message;
                statusEl.classList.remove('hidden');
                statusEl.classList.add('text-red-400');
            }
        }

        /**
         * Assigns or clears an award in the local farmersData array.
         */
        window.assignAward = function(farmerId, awardType) {
            const farmerIndex = farmersData.findIndex(f => f.id === farmerId);
            if (farmerIndex === -1) return;

            let key = '';
            let awardName = '';

            if (awardType === 'fotd') {
                key = 'farmerOfTheDay';
                awardName = 'Content Farmer of the Day';
            } else if (awardType === 'fotm') {
                key = 'farmerOfTheMonth';
                awardName = 'Content Farmer of the Month';
            } else {
                return;
            }

            const isCurrentlyAssigned = farmersData[farmerIndex][key];
            let message;
            
            try {
                // 1. Clear the award from all farmers who currently hold it (if assigning)
                if (!isCurrentlyAssigned) {
                    farmersData.forEach(f => {
                        if (f[key] === true) {
                            f[key] = false; // Clear the award
                        }
                    });
                }
                
                // 2. Toggle the award on the selected farmer
                farmersData[farmerIndex][key] = !isCurrentlyAssigned;

                message = !isCurrentlyAssigned
                    ? `Assigned ${awardName} to ${farmersData[farmerIndex].name}.`
                    : `Removed ${awardName} from ${farmersData[farmerIndex].name}.`;

                saveDataToLocalStorage();
                showMessage(awardName + ' Status', message);
                updateView();
                
            } catch (e) {
                console.error("Error assigning award: ", e);
                showMessage('Error', 'Failed to update awards in local storage: ' + e.message);
            }
        }

        // --- GENERAL MODAL (REPLACEMENT FOR ALERT) ---

        window.showMessage = function(title, body) {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-body').textContent = body;
            document.getElementById('message-modal').classList.remove('hidden');
        }

        window.closeMessageModal = function() {
            document.getElementById('message-modal').classList.add('hidden');
        }

        // Initial setup on window load
        window.onload = initializeData;

    </script>
</body>
</html>